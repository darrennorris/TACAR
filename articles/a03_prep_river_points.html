<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Prepare river points â€¢ TACAR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Prepare river points">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">TACAR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/a01_Interactive-map.html">Population change map</a></li>
    <li><a class="dropdown-item" href="../articles/a02_Matrix-population-model-projections.html">Matrix population model projections</a></li>
    <li><a class="dropdown-item" href="../articles/a03_prep_river_points.html">Prepare river points</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/darrennorris/TACAR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Prepare river points</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/darrennorris/TACAR/blob/main/vignettes/a03_prep_river_points.Rmd" class="external-link"><code>vignettes/a03_prep_river_points.Rmd</code></a></small>
      <div class="d-none name"><code>a03_prep_river_points.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://darrennorris.github.io/TACAR/">TACAR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://had.co.nz/plyr" class="external-link">plyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#library(terra)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyselect.r-lib.org" class="external-link">tidyselect</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-quantities.github.io/units/" class="external-link">units</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="make-points">Make points<a class="anchor" aria-label="anchor" href="#make-points"></a>
</h2>
<div class="section level3">
<h3 id="make-function-">Make function.<a class="anchor" aria-label="anchor" href="#make-function-"></a>
</h3>
<p>Function to make points for each REACH_ID.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># function to make points from Free-flowing River reaches</span></span>
<span><span class="va">river_points</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span><span class="co"># Points by reach</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://tidyselect.r-lib.org" class="external-link">tidyselect</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://r-quantities.github.io/units/" class="external-link">units</a></span><span class="op">)</span></span>
<span><span class="va">din</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">din</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">crop.l</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">din</span><span class="op">)</span></span>
<span><span class="va">geom_col_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">crop.l</span>,<span class="st">"sf_column"</span><span class="op">)</span></span>
<span><span class="va">tmpdf</span> <span class="op">&lt;-</span> <span class="va">din</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu">tidyselect</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">geom_col_name</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># crop.l &lt;- reach_warn_sf</span></span>
<span><span class="va">crop.l</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html" class="external-link">st_sfc</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">crop.l</span><span class="op">)</span><span class="op">)</span>,<span class="st">"LINESTRING"</span><span class="op">)</span></span>
<span><span class="va">crop.l</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="va">crop.l</span><span class="op">)</span></span>
<span><span class="va">myl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_length</a></span><span class="op">(</span><span class="va">crop.l</span><span class="op">)</span><span class="op">)</span>, <span class="va">km</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">crop.l</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html" class="external-link">st_sfc</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">crop.l</span><span class="op">)</span><span class="op">)</span>,<span class="st">"LINESTRING"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sample line</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">myl</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span><span class="va">sf.r.segs</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_line_sample.html" class="external-link">st_line_sample</a></span><span class="op">(</span><span class="va">crop.l</span>, sample <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> </span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span><span class="va">sf.r.segs</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_line_sample.html" class="external-link">st_line_sample</a></span><span class="op">(</span><span class="va">crop.l</span>, density <span class="op">=</span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">/</span><span class="va">km</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="co"># Removes empty gemoetries, caused by sampling reaches with broken lines etc.</span></span>
<span><span class="va">sf.r.segs</span> <span class="op">&lt;-</span>  <span class="va">sf.r.segs</span><span class="op">[</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_query.html" class="external-link">st_dimension</a></span><span class="op">(</span><span class="va">sf.r.segs</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="cn">FALSE</span> <span class="op">)</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">crop.l</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make points</span></span>
<span><span class="va">sf.r.segsp</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html" class="external-link">st_sfc</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">sf.r.segs</span><span class="op">)</span><span class="op">)</span>,<span class="st">"POINT"</span><span class="op">)</span></span>
<span><span class="va">sf.r.segsp</span> <span class="op">&lt;-</span> <span class="va">sf.r.segsp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">sf.r.segsp</span> <span class="op">)</span><span class="op">)</span><span class="op">==</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">sf.r.segs</span><span class="op">)</span></span>
<span><span class="va">n_rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sf.r.segsp</span><span class="op">)</span></span>
<span><span class="va">tmpdf</span> <span class="op">&lt;-</span> <span class="va">tmpdf</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">n_rows</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">tmpdf</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="co"># Return sf</span></span>
<span><span class="va">tmpsf</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">st_sf</a></span><span class="op">(</span><span class="va">tmpdf</span>, geom <span class="op">=</span> <span class="va">sf.r.segsp</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">tmpdf</span><span class="op">)</span></span>
<span><span class="va">tmpsf</span><span class="op">$</span><span class="va">aid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">tmpsf</span><span class="op">)</span></span>
<span><span class="va">tmpsf</span><span class="op">$</span><span class="va">reach_id_point</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">tmpsf</span><span class="op">$</span><span class="va">REACH_ID</span>, <span class="va">tmpsf</span><span class="op">$</span><span class="va">aid</span>, sep<span class="op">=</span><span class="st">"_"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dfout</span> <span class="op">&lt;-</span> <span class="va">tmpsf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">tmpsf</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">dfout</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="process-full-data">Process full data<a class="anchor" aria-label="anchor" href="#process-full-data"></a>
</h3>
<p>First make files holding free-flowing rivers and basins for future
use.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Crop to basins from Norris et. al. 2019.</span></span>
<span><span class="va">basin_in</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"vector\\shape_basin\\amazon_orinoco.shp"</span>, </span>
<span>                        package <span class="op">=</span> <span class="st">"TACAR"</span><span class="op">)</span></span>
<span><span class="va">basins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">basin_in</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html" class="external-link">sf_use_s2</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co"># to avoid duplicate vertex error</span></span>
<span><span class="va">basins_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="va">basins</span>, <span class="fl">0</span><span class="op">)</span>, by_feature <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">BASIN_NAME</span>, <span class="va">subbasin</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">Area_km2</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="st">"MULTIPOLYGON"</span><span class="op">)</span></span>
<span><span class="va">basins_clean</span><span class="op">$</span><span class="va">BASIN_FLAG</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">basins_clean</span><span class="op">$</span><span class="va">BASIN_NAME</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">basins_clean</span><span class="op">$</span><span class="va">SUBBASIN_FLAG</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">basins_clean</span><span class="op">$</span><span class="va">subbasin</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">basins_clean_3395</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">basins_clean</span>, crs<span class="op">=</span><span class="fl">3395</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="va">area</span><span class="op">)</span></span>
<span><span class="va">basin_bbox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">basins_clean</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Free-flowing rivers</span></span>
<span><span class="va">ffr_in</span> <span class="op">&lt;-</span> <span class="st">"C:\\Users\\user\\Documents\\Articles\\gis_layers\\hydro_data\\sa_FFR_river_v1\\sa_FFR_river_v1.shp"</span></span>
<span><span class="va">ffr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">ffr_in</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">RIV_ORD</span> <span class="op">&lt;=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">DIS_AV_CMS</span> <span class="op">&gt;=</span> <span class="fl">15</span><span class="op">)</span></span>
<span><span class="va">ffr_1a5_poun_3395</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html" class="external-link">st_crop</a></span><span class="op">(</span><span class="va">ffr</span>, <span class="va">basin_bbox</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fl">3395</span><span class="op">)</span></span>
<span><span class="co"># with duplicate REACH_ID.... ????</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">ffr_1a5_poun_3395</span><span class="op">$</span><span class="va">REACH_ID</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Add basins to rivers.</span></span>
<span><span class="va">ffr_1a5_poun_3395_basins</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">ffr_1a5_poun_3395</span>, </span>
<span>                                                <span class="va">basins_clean_3395</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/popdemo/man/Projection-plots.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">basins_clean_3395</span><span class="op">[</span><span class="st">"BASIN_NAME"</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">outfile</span> <span class="op">&lt;-</span> <span class="st">"C:\\Users\\user\\Documents\\Articles\\2024_Norris_Greenstatus\\TACAR\\inst\\vector\\poun_rivers_v2.gpkg"</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html" class="external-link">st_write</a></span><span class="op">(</span><span class="va">ffr_1a5_poun_3395_basins</span>, dsn <span class="op">=</span> <span class="va">outfile</span>, </span>
<span>         layer <span class="op">=</span> <span class="st">"ffr_1a5_poun_3395"</span>, layer_options <span class="op">=</span> <span class="st">"SPATIAL_INDEX=NO"</span>, </span>
<span>         delete_layer <span class="op">=</span> <span class="cn">TRUE</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html" class="external-link">st_write</a></span><span class="op">(</span><span class="va">basins_clean_3395</span>, dsn <span class="op">=</span> <span class="va">outfile</span>, </span>
<span>         layer <span class="op">=</span> <span class="st">"basins_poun_3395"</span>, layer_options <span class="op">=</span> <span class="st">"SPATIAL_INDEX=NO"</span>, </span>
<span>         delete_layer <span class="op">=</span> <span class="cn">TRUE</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Now convert river lines to points regularly spaced by approximately 1
kilometer.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Test and see if can run Orinoco, South and North per basin. </span></span>
<span><span class="co"># Then Amazon by subbasin. Maybe setup with parallel to go quicker.</span></span>
<span><span class="co"># 1) Load Free-flowing rivers made previously.</span></span>
<span><span class="va">infile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"vector\\poun_rivers_v2.gpkg"</span>, package <span class="op">=</span> <span class="st">"TACAR"</span><span class="op">)</span></span>
<span><span class="va">ffr_1a5_poun_3395</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="va">infile</span>, layer <span class="op">=</span> <span class="st">"ffr_1a5_poun_3395"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># With 1 to 4 overall length 160,208. Norris et al. 2019 was 215,975. 165 Access, 50 not.</span></span>
<span><span class="co"># 76% rivers accessible. 57.2% Accessible and unprotected.</span></span>
<span><span class="co"># 354070 km with 1 to 5.</span></span>
<span><span class="va">lenth_tot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_length</a></span><span class="op">(</span><span class="va">ffr_1a5_poun_3395</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1000</span></span>
<span><span class="co">#Number of reaches by basin</span></span>
<span><span class="co"># table(ffr_1a4_poun_3395$BASIN_NAME)</span></span>
<span><span class="co"># Amazon    Coastal North  Coastal South   Orinoco </span></span>
<span><span class="co"># 51871          3728           945          8476 </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">ffr_1a5_poun_3395</span><span class="op">$</span><span class="va">BASIN_NAME</span><span class="op">)</span></span>
<span><span class="co">#      Amazon Coastal North Coastal South       Orinoco </span></span>
<span><span class="co">#     111942          8833          2321         19440 </span></span>
<span> <span class="va">basin_river_lengths</span> <span class="op">&lt;-</span> <span class="va">ffr_1a5_poun_3395</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>reach_length_km <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_length</a></span><span class="op">(</span><span class="va">ffr_1a5_poun_3395</span><span class="op">)</span>, <span class="va">km</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">BASIN_NAME</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>river_km <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">reach_length_km</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">basin_river_lengths</span> <span class="co"># with 1 to 4</span></span>
<span><span class="co">#  BASIN_NAME    river_km</span></span>
<span><span class="co">#1 Amazon         128771.</span></span>
<span><span class="co">#2 Coastal North    9198.</span></span>
<span><span class="co">#3 Coastal South    2515.</span></span>
<span><span class="co">#4 Orinoco         19724.</span></span>
<span><span class="va">basin_river_lengths</span></span>
<span><span class="co">#  BASIN_NAME    river_km</span></span>
<span><span class="co"># Amazon         280360.</span></span>
<span><span class="co"># Coastal North   21194.</span></span>
<span><span class="co"># Coastal South    6507.</span></span>
<span><span class="co"># Orinoco         46009.</span></span>
<span> <span class="co"># 2) Seperate basins. Makes testing and processing easier.</span></span>
<span><span class="co"># If you used parallel this would be much more efficient.</span></span>
<span><span class="co"># But the time it would take me to code parallel is actually longer than seperate process.</span></span>
<span><span class="va">df_ffr_1a5_poun_3395_south</span> <span class="op">&lt;-</span> <span class="va">ffr_1a5_poun_3395</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">BASIN_NAME</span> <span class="op">==</span> <span class="st">"Coastal South"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">df_ffr_1a5_poun_3395_north</span> <span class="op">&lt;-</span> <span class="va">ffr_1a5_poun_3395</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">BASIN_NAME</span> <span class="op">==</span> <span class="st">"Coastal North"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">df_ffr_1a5_poun_3395_orinoco</span> <span class="op">&lt;-</span> <span class="va">ffr_1a5_poun_3395</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">BASIN_NAME</span> <span class="op">==</span> <span class="st">"Orinoco"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">df_ffr_1a5_poun_3395_amazon</span> <span class="op">&lt;-</span> <span class="va">ffr_1a5_poun_3395</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">BASIN_NAME</span> <span class="op">==</span> <span class="st">"Amazon"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># 3) River lines to points.</span></span>
<span><span class="co"># South. n = 2568 on 15/7/2024. 2515 km of RIV_ORD 1 to 4 rivers.</span></span>
<span><span class="co"># South. n = 6627 on 18/7/2024. 6507 km of RIV_ORD 1 to 5 rivers.</span></span>
<span><span class="va">dfpoints_south</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/ddply.html" class="external-link">ddply</a></span><span class="op">(</span><span class="va">df_ffr_1a5_poun_3395_south</span>, <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/quoted.html" class="external-link">.</a></span><span class="op">(</span><span class="va">REACH_ID</span><span class="op">)</span>, </span>
<span>                        .fun <span class="op">=</span> <span class="va">river_points</span><span class="op">)</span></span>
<span><span class="va">sf_points_south</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">dfpoints_south</span><span class="op">)</span></span>
<span><span class="fu">mapview</span><span class="fu">::</span><span class="fu">mapview</span><span class="op">(</span><span class="va">sf_points_south</span><span class="op">)</span></span>
<span><span class="co"># North - warning number of items to replace is not a multiple of replacement length</span></span>
<span><span class="co"># reach_warn &lt;- df_ffr_1a4_poun_3395_north[3632, "REACH_ID"]</span></span>
<span><span class="co"># reach_warn_sf &lt;- df_ffr_1a4_poun_3395_north[3632, ] |&gt; </span></span>
<span><span class="co">#  st_as_sf()</span></span>
<span><span class="co"># mapview::mapview(reach_warn_sf)</span></span>
<span><span class="co"># Solved - caused by empty point geometry from sample of reach with broken lines.</span></span>
<span><span class="co"># North - warning row names were found from a short variable and have been discarded</span></span>
<span><span class="co"># cant find where this warning comes from........</span></span>
<span><span class="co"># North. n = 9442 on 15 July 2024. 9198 km of RIV_ORD 1 to 4 rivers.</span></span>
<span><span class="co"># North. n = 21746 on 18 July 2024. 21194 km of RIV_ORD 1 to 5 rivers.</span></span>
<span><span class="va">dfpoints_north</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/ddply.html" class="external-link">ddply</a></span><span class="op">(</span><span class="va">df_ffr_1a5_poun_3395_north</span>, <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/quoted.html" class="external-link">.</a></span><span class="op">(</span><span class="va">REACH_ID</span><span class="op">)</span>, </span>
<span>                        .fun <span class="op">=</span> <span class="va">river_points</span><span class="op">)</span></span>
<span><span class="co"># Orinoco. n = 20515 on 15 July 2024 19724 km of RIV_ORD 1 to 4 rivers.</span></span>
<span><span class="co"># Orinoco. n =  47730 on 18 July 2024 46009 km of RIV_ORD 1 to 5 rivers.</span></span>
<span><span class="va">dfpoints_orinoco</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/ddply.html" class="external-link">ddply</a></span><span class="op">(</span><span class="va">df_ffr_1a5_poun_3395_orinoco</span>, <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/quoted.html" class="external-link">.</a></span><span class="op">(</span><span class="va">REACH_ID</span><span class="op">)</span>, </span>
<span>                        .fun <span class="op">=</span> <span class="va">river_points</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now Amazon. By subbasin to reduce memory demands....</span></span>
<span><span class="co"># 17:24 - 18:28ish. 132027 points. 128771 km on 15 July 2024.</span></span>
<span><span class="co"># 17:23 - 19:30ish. 287103 points. 280360 km on 18 July, FFR 1 to 5.</span></span>
<span><span class="va">dfpoints_amazon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/ddply.html" class="external-link">ddply</a></span><span class="op">(</span><span class="va">df_ffr_1a5_poun_3395_amazon</span>, </span>
<span>                         <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/quoted.html" class="external-link">.</a></span><span class="op">(</span><span class="va">SUBBASIN_FLAG</span>, <span class="va">REACH_ID</span><span class="op">)</span>, </span>
<span>                        .fun <span class="op">=</span> <span class="va">river_points</span><span class="op">)</span></span></code></pre></div>
<p>Tidy for export.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sf_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">dfpoints_amazon</span>, <span class="va">dfpoints_north</span>, </span>
<span>                    <span class="va">dfpoints_orinoco</span>, <span class="va">dfpoints_south</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">sf_res</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">sf_res</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">sf_res</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">sf_res</span><span class="op">)</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span>
<span><span class="co"># Drop any within 10 meter radius?</span></span>
<span><span class="va">sf_res</span> <span class="op">&lt;-</span> <span class="va">sf_res</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>coord_text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">x</span>, <span class="op">-</span><span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">y</span>, <span class="op">-</span><span class="fl">2</span><span class="op">)</span>, sep<span class="op">=</span><span class="st">"_"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sf_res</span><span class="op">$</span><span class="va">dupe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">sf_res</span><span class="op">$</span><span class="va">coord_text</span><span class="op">)</span></span>
<span><span class="co"># This remains close to original length. </span></span>
<span><span class="co"># 160189 points, total river km = 160,208</span></span>
<span><span class="co"># 353637 points, total river km = 354,070.</span></span>
<span><span class="va">sf_res_out</span> <span class="op">&lt;-</span> <span class="va">sf_res</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">dupe</span>, <span class="va">LENGTH_KM</span> <span class="op">&gt;=</span> <span class="fl">.5</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Export for future use. Avoid GDAL spatial index warning.</span></span>
<span><span class="co">#outfile &lt;- "C:\\Users\\user\\Documents\\Articles\\2024_Norris_Greenstatus\\TACAR\\inst\\vector\\poun_river_points.gpkg"</span></span>
<span><span class="co">#st_write(sf_res_out, dsn = outfile, </span></span>
<span><span class="co">#         layer = "ffr_1a4_poun_points_3395", </span></span>
<span><span class="co">#         layer_options = "SPATIAL_INDEX=NO", delete_layer = TRUE, append = TRUE)</span></span>
<span></span>
<span><span class="va">outfile</span> <span class="op">&lt;-</span> <span class="st">"C:\\Users\\user\\Documents\\Articles\\2024_Norris_Greenstatus\\TACAR\\inst\\vector\\poun_river_points_v2.gpkg"</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html" class="external-link">st_write</a></span><span class="op">(</span><span class="va">sf_res_out</span>, dsn <span class="op">=</span> <span class="va">outfile</span>, </span>
<span>         layer <span class="op">=</span> <span class="st">"ffr_1a5_poun_points_3395"</span>, </span>
<span>         layer_options <span class="op">=</span> <span class="st">"SPATIAL_INDEX=NO"</span>, delete_layer <span class="op">=</span> <span class="cn">TRUE</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="accessibility-and-pas">Accessibility and PAs<a class="anchor" aria-label="anchor" href="#accessibility-and-pas"></a>
</h2>
<p>Extract accessibility and PAs.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># From Norris et al. 2019.</span></span>
<span><span class="va">uain</span> <span class="op">&lt;-</span> <span class="st">"inst/raster/uas.grd"</span></span>
<span><span class="va">uas</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="va">uain</span><span class="op">)</span></span>
<span><span class="va">newr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">rast</span><span class="op">(</span><span class="st">"inst/raster/access_new.tif"</span><span class="op">)</span>, <span class="fu">rast</span><span class="op">(</span><span class="st">"inst/raster/cost_distance.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">uas_3395</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/popdemo/man/project.html" class="external-link">project</a></span><span class="op">(</span><span class="va">uas</span>, <span class="st">"epsg:3395"</span><span class="op">)</span></span>
<span><span class="va">pe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">uas_3395</span>, <span class="fu">vect</span><span class="op">(</span><span class="va">ffr_1a5_poun_points_3395</span><span class="op">)</span>, bind <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pe</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Indigenous</span>, <span class="va">Dist..km.</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># check NAs. All  where rivers join oceans north east.</span></span>
<span><span class="va">rna</span> <span class="op">&lt;-</span> <span class="va">pe</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Indigenous</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">REACH_ID</span><span class="op">)</span></span>
<span><span class="fu">mapview</span><span class="fu">::</span><span class="fu">mapview</span><span class="op">(</span><span class="va">rna</span><span class="op">)</span></span>
<span><span class="va">pe</span> <span class="op">&lt;-</span> <span class="va">pe</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Indigenous</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">newr</span>, <span class="fu">vect</span><span class="op">(</span><span class="va">pe</span><span class="op">)</span>, bind <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pe</span> <span class="op">&lt;-</span> <span class="va">pe</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="st">"myuse"</span> <span class="op">=</span> <span class="st">"Use"</span><span class="op">)</span></span>
<span><span class="va">pe</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">access_new</span>, <span class="va">cost_distance</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="co"># Keep size to less tham 100 MB</span></span>
<span><span class="va">pe</span> <span class="op">&lt;-</span> <span class="va">pe</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">access_new</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">OBJECTID</span>, <span class="va">GOID</span>, <span class="va">NOID</span>, <span class="va">NUOID</span>, <span class="va">NDOID</span>, <span class="va">CON_ID</span>, </span>
<span>            <span class="va">CONTINENT</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">coord_text</span>, <span class="va">dupe</span>, <span class="va">mask</span>, <span class="va">aid</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Export for future use.</span></span>
<span><span class="co"># outfile &lt;- "C:\\Users\\user\\Documents\\Articles\\2024_Norris_Greenstatus\\TACAR\\inst\\vector\\poun_river_points.gpkg"</span></span>
<span><span class="co">#outfile &lt;- "C:\\Users\\user\\Documents\\Articles\\2024_Norris_Greenstatus\\TACAR\\inst\\poun_river_points.gpkg"</span></span>
<span><span class="va">outfile</span> <span class="op">&lt;-</span> <span class="st">"C:\\Users\\user\\Documents\\Articles\\2024_Norris_Greenstatus\\TACAR\\inst\\vector\\poun_river_points_v2.gpkg"</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html" class="external-link">st_write</a></span><span class="op">(</span><span class="va">pe</span>, dsn <span class="op">=</span> <span class="va">outfile</span>, </span>
<span>         layer <span class="op">=</span> <span class="st">"ffr_1a5_poun_points_3395"</span>, </span>
<span>         layer_options <span class="op">=</span> <span class="st">"SPATIAL_INDEX=NO"</span>, delete_layer <span class="op">=</span> <span class="cn">TRUE</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="hydrobasin-codes">HydroBasin codes<a class="anchor" aria-label="anchor" href="#hydrobasin-codes"></a>
</h2>
<p>Add HydroBasin levels 3, 4, 5 and 6. These will also be used to
generate a flag to exclude any basins where the species does not
occur.</p>
<p>HYBAS_ID Unique basin identifier. The code consists of 10 digits: â€¢
First 1 digit represents the region: 1 = Africa; 2 = Europe; 3 =
Siberia; 4 = Asia; 5 = Australia; 6 = South America; 7 = North America;
8 = Arctic (North America); 9 = Greenland â€¢ Next 2 digits define the
Pfafstetter level (01-12). The value â€˜00â€™ is used for the â€˜Level 0â€™
layer that contains all original sub-basins and all Pfafstetter codes
(at all levels); â€˜Level 0â€™ only exists in the standard format of
HydroBASINS (without lakes). â€¢ Next 6 digits represent a unique
identifier within the HydroSHEDS network; values larger than 900,000
represent lakes and only occur in the customized format (with lakes) â€¢
Last 1 digit indicates the side of a sub-basin in relation to the river
network (0 = noSide; 1 = Left; 2 = Right). Sides are only defined for
the customized format (with lakes).</p>
<p>Pfaf_id The Pfafstetter code. For general description see literature
(e.g., Verdin and Verdin 1999). The Pfafstetter code uses as many digits
as the level it represents. This field can be used to cluster or
subdivide sub-basins into nested regions. This field is only available
for levels 1-12 (i.e.Â not for the â€˜Level 0â€™ layer of the standard
format).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># bbox to reduce processing time</span></span>
<span><span class="va">poun_bbox_3395</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">ffr_1a5_poun_3395</span><span class="op">)</span></span>
<span><span class="co"># HydroBasin files</span></span>
<span><span class="va">hydrobasin_l3_in</span> <span class="op">&lt;-</span> <span class="st">"C:\\Users\\user\\Documents\\Articles\\gis_layers\\hydro_data\\hybas_sa_lev01-12_v1c\\hybas_sa_lev03_v1c.shp"</span></span>
<span><span class="va">hydrobasin_l4_in</span> <span class="op">&lt;-</span> <span class="st">"C:\\Users\\user\\Documents\\Articles\\gis_layers\\hydro_data\\hybas_sa_lev01-12_v1c\\hybas_sa_lev04_v1c.shp"</span></span>
<span><span class="va">hydrobasin_l5_in</span> <span class="op">&lt;-</span> <span class="st">"C:\\Users\\user\\Documents\\Articles\\gis_layers\\hydro_data\\hybas_sa_lev01-12_v1c\\hybas_sa_lev05_v1c.shp"</span></span>
<span><span class="va">hydrobasin_l6_in</span> <span class="op">&lt;-</span> <span class="st">"C:\\Users\\user\\Documents\\Articles\\gis_layers\\hydro_data\\hybas_sa_lev01-12_v1c\\hybas_sa_lev06_v1c.shp"</span></span>
<span></span>
<span><span class="co"># load files</span></span>
<span><span class="va">hydrobasins_l3</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">hydrobasin_l3_in</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs<span class="op">=</span><span class="fl">3395</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="st">"MULTIPOLYGON"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html" class="external-link">st_crop</a></span><span class="op">(</span><span class="va">poun_bbox_3395</span><span class="op">)</span></span>
<span><span class="va">hydrobasins_l4</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">hydrobasin_l4_in</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs<span class="op">=</span><span class="fl">3395</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="st">"MULTIPOLYGON"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html" class="external-link">st_crop</a></span><span class="op">(</span><span class="va">poun_bbox_3395</span><span class="op">)</span></span>
<span><span class="va">hydrobasins_l5</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">hydrobasin_l5_in</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs<span class="op">=</span><span class="fl">3395</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="st">"MULTIPOLYGON"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html" class="external-link">st_crop</a></span><span class="op">(</span><span class="va">poun_bbox_3395</span><span class="op">)</span></span>
<span><span class="va">hydrobasins_l6</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">hydrobasin_l6_in</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs<span class="op">=</span><span class="fl">3395</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="st">"MULTIPOLYGON"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html" class="external-link">st_crop</a></span><span class="op">(</span><span class="va">poun_bbox_3395</span><span class="op">)</span></span>
<span><span class="co"># Points</span></span>
<span><span class="va">infile</span> <span class="op">&lt;-</span> <span class="st">"C:\\Users\\user\\Documents\\Articles\\2024_Norris_Greenstatus\\TACAR\\inst\\vector\\poun_river_points_v2.gpkg"</span></span>
<span><span class="va">ffr_1a5_poun_points_3395</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span>dsn <span class="op">=</span> <span class="va">infile</span>, </span>
<span>                                    layer <span class="op">=</span> <span class="st">"ffr_1a5_poun_points_3395"</span><span class="op">)</span></span>
<span><span class="co"># appears to be 114 duplicates</span></span>
<span><span class="va">ffr_1a5_poun_points_3395</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">reach_id_point</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>acount <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">acount</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">acount</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># check duplicates. Here from French Guiana, same reach id in Coastal North and South</span></span>
<span><span class="va">ffr_1a5_poun_points_3395</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">reach_id_point</span> <span class="op">==</span> <span class="st">"60158665_1"</span><span class="op">)</span></span>
<span><span class="co"># Here duplicate REACH_ID, both from Amazon, different subbasins - </span></span>
<span><span class="co"># Amazon floodplain and Minor Amazon tribs Pacaj\xe1</span></span>
<span><span class="va">ffr_1a5_poun_points_3395</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">reach_id_point</span> <span class="op">==</span> <span class="st">"60500077_1"</span><span class="op">)</span></span>
<span><span class="co"># Add HydroBasins to rivers. 19:26 - 19:46</span></span>
<span><span class="co">#geom column name</span></span>
<span><span class="va">geocol</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">ffr_1a5_poun_points_3395</span>,<span class="st">"sf_column"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ffr_1a5_poun_3395_hb_l3</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">ffr_1a5_poun_points_3395</span> <span class="op">|&gt;</span> </span>
<span>                                                 <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">REACH_ID</span>, <span class="va">reach_id_point</span>, </span>
<span>                                                        <span class="va">BASIN_FLAG</span>, <span class="va">SUBBASIN_FLAG</span><span class="op">)</span>, </span>
<span>                                                <span class="va">hydrobasins_l3</span> <span class="op">|&gt;</span> </span>
<span>                                                 <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">HYBAS_ID</span>, <span class="va">PFAF_ID</span>, <span class="va">SUB_AREA</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>                                                 <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HYBAS_ID_l3"</span> <span class="op">=</span> <span class="st">"HYBAS_ID"</span>, </span>
<span>                                                               <span class="st">"PFAF_ID_l3"</span> <span class="op">=</span> <span class="st">"PFAF_ID"</span>, </span>
<span>                                                               <span class="st">"SUB_AREA_l3"</span> <span class="op">=</span> <span class="st">"SUB_AREA"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu">tidyselect</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">geocol</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ffr_1a5_poun_3395_hb_l4</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">ffr_1a5_poun_points_3395</span> <span class="op">|&gt;</span> </span>
<span>                                                 <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">REACH_ID</span>, <span class="va">reach_id_point</span>, </span>
<span>                                                        <span class="va">BASIN_FLAG</span>, <span class="va">SUBBASIN_FLAG</span><span class="op">)</span>, </span>
<span>                                                <span class="va">hydrobasins_l4</span> <span class="op">|&gt;</span> </span>
<span>                                                 <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">HYBAS_ID</span>, <span class="va">PFAF_ID</span>, <span class="va">SUB_AREA</span><span class="op">)</span><span class="op">|&gt;</span> </span>
<span>                                                 <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HYBAS_ID_l4"</span> <span class="op">=</span> <span class="st">"HYBAS_ID"</span>, </span>
<span>                                                               <span class="st">"PFAF_ID_l4"</span> <span class="op">=</span> <span class="st">"PFAF_ID"</span>, </span>
<span>                                                               <span class="st">"SUB_AREA_l4"</span> <span class="op">=</span> <span class="st">"SUB_AREA"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu">tidyselect</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">geocol</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ffr_1a5_poun_3395_hb_l5</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">ffr_1a5_poun_points_3395</span> <span class="op">|&gt;</span> </span>
<span>                                                 <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">REACH_ID</span>, <span class="va">reach_id_point</span>, </span>
<span>                                                        <span class="va">BASIN_FLAG</span>, <span class="va">SUBBASIN_FLAG</span><span class="op">)</span>, </span>
<span>                                                <span class="va">hydrobasins_l5</span> <span class="op">|&gt;</span> </span>
<span>                                                 <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">HYBAS_ID</span>, <span class="va">PFAF_ID</span>, <span class="va">SUB_AREA</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>                                                 <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HYBAS_ID_l5"</span> <span class="op">=</span> <span class="st">"HYBAS_ID"</span>, </span>
<span>                                                               <span class="st">"PFAF_ID_l5"</span> <span class="op">=</span> <span class="st">"PFAF_ID"</span>, </span>
<span>                                                               <span class="st">"SUB_AREA_l5"</span> <span class="op">=</span> <span class="st">"SUB_AREA"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu">tidyselect</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">geocol</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ffr_1a5_poun_3395_hb_l6</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">ffr_1a5_poun_points_3395</span> <span class="op">|&gt;</span> </span>
<span>                                                 <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">REACH_ID</span>, <span class="va">reach_id_point</span>, </span>
<span>                                                        <span class="va">BASIN_FLAG</span>, <span class="va">SUBBASIN_FLAG</span><span class="op">)</span>, </span>
<span>                                                <span class="va">hydrobasins_l6</span> <span class="op">|&gt;</span> </span>
<span>                                                 <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">HYBAS_ID</span>, <span class="va">PFAF_ID</span>, <span class="va">SUB_AREA</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>                                                 <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HYBAS_ID_l6"</span> <span class="op">=</span> <span class="st">"HYBAS_ID"</span>, </span>
<span>                                                               <span class="st">"PFAF_ID_l6"</span> <span class="op">=</span> <span class="st">"PFAF_ID"</span>, </span>
<span>                                                               <span class="st">"SUB_AREA_l6"</span> <span class="op">=</span> <span class="st">"SUB_AREA"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu">tidyselect</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">geocol</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">points_hydrobasin</span> <span class="op">&lt;-</span> <span class="va">ffr_1a5_poun_3395_hb_l3</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">ffr_1a5_poun_3395_hb_l4</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">ffr_1a5_poun_3395_hb_l5</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Now join back with points</span></span>
<span><span class="va">ffr_1a5_poun_points_hb_3395</span> <span class="op">&lt;-</span> <span class="va">ffr_1a5_poun_points_3395</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">points_hydrobasin</span><span class="op">)</span></span>
<span><span class="co"># Export for future use.</span></span>
<span><span class="co">#outfile &lt;- "C:\\Users\\user\\Documents\\Articles\\2024_Norris_Greenstatus\\TACAR\\inst\\vector\\poun_river_points_v2.gpkg"</span></span>
<span><span class="co"># remove some columns to keep filesize below 100 MB.</span></span>
<span><span class="co">#ffr_1a5_poun_points_hb_3395 |&gt; </span></span>
<span><span class="co">#  dplyr::select(!c(UPLAND_SKM, BB_LEN_KM, BB_OCEAN)) |&gt;</span></span>
<span><span class="co">#sf::st_write(dsn = outfile, </span></span>
<span><span class="co">#         layer = "ffr_1a5_poun_points_3395", </span></span>
<span><span class="co">#         layer_options = "SPATIAL_INDEX=NO", delete_layer = TRUE, append = TRUE)</span></span>
<span></span>
<span><span class="co"># Need to add HydroBasin level 6.</span></span>
<span><span class="co"># Export as seperate gpkg to remain within file size limit</span></span>
<span><span class="co"># Join back with points</span></span>
<span><span class="va">ffr_1a5_poun_points_hb_3395</span> <span class="op">&lt;-</span> <span class="va">ffr_1a5_poun_points_3395</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">ffr_1a5_poun_3395_hb_l6</span><span class="op">)</span></span>
<span><span class="va">outfile</span> <span class="op">&lt;-</span> <span class="st">"C:\\Users\\user\\Documents\\Articles\\2024_Norris_Greenstatus\\TACAR\\inst\\vector\\poun_river_points_hb_v1.gpkg"</span></span>
<span><span class="co"># Retain only columns needed to join</span></span>
<span><span class="va">ffr_1a5_poun_points_hb_3395</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">REACH_ID</span>, <span class="va">BASIN_FLAG</span>, <span class="va">SUBBASIN_FLAG</span>, <span class="va">reach_id_point</span>, </span>
<span>                <span class="va">HYBAS_ID_l3</span>, <span class="va">PFAF_ID_l3</span>, <span class="va">SUB_AREA_l3</span>, </span>
<span>                <span class="va">HYBAS_ID_l4</span>, <span class="va">PFAF_ID_l4</span>, <span class="va">SUB_AREA_l4</span>, </span>
<span>                <span class="va">HYBAS_ID_l5</span>, <span class="va">PFAF_ID_l5</span>, <span class="va">SUB_AREA_l5</span>, </span>
<span>                <span class="va">HYBAS_ID_l6</span>, <span class="va">PFAF_ID_l6</span>, <span class="va">SUB_AREA_l6</span>,</span>
<span>                <span class="va">geom</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html" class="external-link">st_write</a></span><span class="op">(</span>dsn <span class="op">=</span> <span class="va">outfile</span>, </span>
<span>         layer <span class="op">=</span> <span class="st">"ffr_1a5_poun_points_hb_3395"</span>, </span>
<span>         layer_options <span class="op">=</span> <span class="st">"SPATIAL_INDEX=NO"</span>, delete_layer <span class="op">=</span> <span class="cn">TRUE</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Now add column that flags basins that should be excluded.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">infile</span> <span class="op">&lt;-</span> <span class="st">"C:\\Users\\user\\Documents\\Articles\\2024_Norris_Greenstatus\\TACAR\\inst\\vector\\poun_river_points_hb_v1.gpkg"</span></span>
<span><span class="va">ffr_1a5_poun_points_hb_3395</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span>dsn <span class="op">=</span> <span class="va">infile</span>, </span>
<span>                                    layer <span class="op">=</span> <span class="st">"ffr_1a5_poun_points_hb_3395"</span><span class="op">)</span></span>
<span><span class="co"># Exclude level 6 basins from French Guiana, indicted by Benoit</span></span>
<span><span class="co"># https://github.com/darrennorris/TACAR/issues/1</span></span>
<span><span class="va">exclude_French_Guiana_l6</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6060005530</span>, <span class="fl">6060005540</span>, <span class="fl">6060005660</span><span class="op">)</span></span>
<span><span class="va">ffr_1a5_poun_points_hb_3395</span><span class="op">$</span><span class="va">flag_exclude</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">ffr_1a5_poun_points_hb_3395</span><span class="op">$</span><span class="va">HYBAS_ID_l6</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">exclude_French_Guiana_l6</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co"># Check. All ok.</span></span>
<span><span class="va">acheck</span> <span class="op">&lt;-</span> <span class="va">ffr_1a5_poun_points_hb_3395</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">flag_exclude</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">mapview</span><span class="fu">::</span><span class="fu">mapview</span><span class="op">(</span><span class="va">acheck</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Export for future use</span></span>
<span><span class="va">outfile</span> <span class="op">&lt;-</span> <span class="st">"C:\\Users\\user\\Documents\\Articles\\2024_Norris_Greenstatus\\TACAR\\inst\\vector\\poun_river_points_hb_v1.gpkg"</span></span>
<span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html" class="external-link">st_write</a></span><span class="op">(</span><span class="va">ffr_1a5_poun_points_hb_3395</span>, dsn <span class="op">=</span> <span class="va">outfile</span>, </span>
<span>         layer <span class="op">=</span> <span class="st">"ffr_1a5_poun_points_hb_3395"</span>, </span>
<span>         layer_options <span class="op">=</span> <span class="st">"SPATIAL_INDEX=NO"</span>, delete_layer <span class="op">=</span> <span class="cn">TRUE</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="to-do">To do<a class="anchor" aria-label="anchor" href="#to-do"></a>
</h2>
<ul>
<li><p>Make flag_exclude more informative.<br>
Include additional codes to identify why excluded (never present,
extirpated, no nesting areas etc).</p></li>
<li><p>Include additional flags.<br>
Flags to show 1) where there are conservation actions, 2) evidence of
population recovery.</p></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Darren Norris.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
