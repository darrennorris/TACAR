---
title: "Accessibility"
author: "Darren Norris"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Objectives

 - Make accessibility with Free-flowing rivers and new population density.
 
## Packages and data

### Packages
```{r load-packages}
library(plyr)
library(tidyverse)
library(sf)
library(terra)
library(mapview)
```

### Data
Population density in 2020 from WorldPop: https://www.worldpop.org/.
```{r make-pop, eval=FALSE}
rast_folder <- "C:\\Users\\user\\Documents\\Articles\\gis_layers\\world_pop"
rastlist <- list.files(path = rast_folder, pattern='.tif$', 
                       all.files=TRUE, full.names=TRUE)
rsrc <- sprc(rastlist)
m <- merge(rsrc)
# Plot to check
plot(log1p(m))

# Crop by original river points
sr <- readRDS("inst/other/scenario_res_current.rds") |> 
  st_as_sf()
crop_box <- ext(vect(st_transform(sr, 4326)))
m <- crop(m, crop_box, snap = "out")
names(m) <- "worldpop_pd_2020_1km"
# Plot to check
plot(log1p(m))
# save for further processing
writeRaster(m, "inst/raster/worldpop_pd_2020_1km.tif", 
              gdal=c("COMPRESS=DEFLATE"), overwrite = TRUE)
```

## Cost surface

### Understand cost surface

```{r test-cost-surface}
# understand costDist. Adaoted from help.....
# 0 for areas with >= 3 people per km
# 1 = river path and NA not river.
r <- rast(ncols=10, nrows=10,  xmin=0, xmax= (10*1000), 
          ymin=0, ymax=(10*1000), 
		   vals = 0, crs="+proj=utm +zone=1 +datum=WGS84")
# Values
r[2:3, 1] <- r[1, 2:4] <- r[2:6, 5] <- r[6, 6:10] <- 1
r[7:10, 1:10] <- r[1:5, 6:10] <- r[2:5, 2:4] <- NA
r[8, 6:8] <- 0
r[9, 1:4] <- r[9, 9] <- r[10, 10] <- 1
plot(r)
d <- costDist(r, scale = 1000)
plot(log1p(d))
text(d, digits=1, cex=.8)

```

### Check with Amapá.
```{r check-cost-surface}
m <- rast("inst/raster/worldpop_pd_2020_1km.tif")
# Use Amapá to check/test
library(geobr)
ap <- read_state(
  code_state="AP",
  year=2020,
  showProgress = FALSE
  )
ap_crop_box <- ext(vect(st_transform(ap, 4326)))
ap_crop_bbox <- st_bbox(st_transform(ap, 4326))
m_ap <- crop(m, ap_crop_box)
#plot to check
plot(log1p(m_ap))
# reclass b4 transform
m_ap_rc <- ifel(m_ap >= 5, 10, 0)
plot(m_ap_rc)
mapview::mapview(m_ap_rc)
# project for costdist analysis
m_3395 <- project(m_ap_rc, method = "near","epsg:3395")
plot(m_3395)
#writeRaster(m_ap_rc, "inst/raster/worldpop_3pkm_rc_ap.tif", 
#              gdal=c("COMPRESS=DEFLATE"), overwrite = TRUE)
writeRaster(m_ap_rc, "inst/raster/worldpop_5pkm_rc_ap.tif", 
              gdal=c("COMPRESS=DEFLATE"), overwrite = TRUE)
writeRaster(m_ap, "inst/raster/worldpop_ap.tif", 
              gdal=c("COMPRESS=DEFLATE"), overwrite = TRUE)
# crop and rasterize rivers
m_3395c <- m_3395
m_3395c <- ifel(!is.na(m_3395),0 , NA)
ffr_in <- "C:\\Users\\user\\Documents\\Articles\\gis_layers\\hydro_data\\sa_FFR_river_v1\\sa_FFR_river_v1.shp"
# Crop to Amapá
ffr_ap_3395 <- read_sf(ffr_in) |> st_crop(ap_crop_bbox) |> st_transform(3395)
ffr_ap_3395$myval <- 1

# 1 to 4 close 70% of Norris et al. 2019. Including 5 adds Capivara/Primeiro Braco
ffr_ap_1a4_3395 <- ffr_ap_3395 |> 
  filter(RIV_ORD <= 4) 
ffr_ap_1a5_3395 <- ffr_ap_3395 |> 
  filter(RIV_ORD <= 5) |> 
  filter(DIS_AV_CMS >= 15)
# Use all rivers to make cost-distance surface
r_ffr <- rasterize(vect(ffr_ap_3395), m_3395c, field = "myval", 
                   update = TRUE, touches = TRUE)
# Population density NAs are water. Change NA to 1.
mapview::mapview(r_ffr) + 
  mapview::mapview(ffr_ap_1a5_3395)
r_ffr <- ifel(is.na(r_ffr), 1, r_ffr)
rf <- r_ffr + ifel(is.na(m_3395), 0, m_3395)
rf <- ifel(rf == 0, NA, rf)
rf <- ifel(rf >= 10, 0, rf)
mapview::mapview(rf) + 
  mapview::mapview(ffr_ap_1a5_3395)

cd_access <- costDist(rf, scale = 1000)
cd_map <- ifel(cd_access >= 48, 0, 1)
names(cd_map) <- "access_new"
mapview::mapview(cd_map) +
mapview::mapview(ffr_ap_1a5_3395)

```

#### Compare AP with original

How much changes compared with Norris et al 2019? Around half are NAs...
Using river order 1 - 4 or 1 - 5 changes results how??

```{r compare-res}
# st_crop just by bbox. terra::crop within polygon.
sr_ap <- crop(vect(sr), vect(st_transform(ap, 3395)))
sr_ap_new <- st_as_sf(extract(cd_map, sr_ap, bind = TRUE))
summary(sr_ap_new$access_new) # half NA
# assume equal probability of NA between with and without access
mapview::mapview(cd_map, na.color = "transparent") +
mapview::mapview(ffr_ap_1a4_3395) + 
 mapview::mapview(sr_ap_new, zcol = "access_new") 

# compare new classification with old
mapview::mapview(cd_map, na.color = "transparent") +
mapview::mapview(ffr_ap_1a4_3395) + 
 mapview::mapview(sr_ap_new, zcol = "Accessible") 

sr_ap_new |> data.frame() |> 
  filter(!is.na(access_new)) |> 
  group_by(Accessible, access_new) |> 
  summarise(acount = n())
# Not = 894 Access = 3375
sr_ap_new |> data.frame() |> 
  filter(!is.na(access_new)) |> 
  group_by(Accessible) |>  summarise(acount = n())
# Not = 1416 Access = 2853
sr_ap_new |> data.frame() |> 
  filter(!is.na(access_new)) |> 
  group_by(access_new) |>  summarise(acount = n())
```


### Make full data
Load data needed.
```{r load-full-data}
# World population cropped to poun buffered range.
pd <- rast("inst/raster/worldpop_pd_2020_1km.tif") # 4326
# River points
sr <- readRDS("inst/other/scenario_res_current.rds") |> 
  st_as_sf() # 3395
# Extent around points - same as "pd".
crop_box <- ext(vect(st_transform(sr, 4326)))
crop_bbox <- st_bbox(st_transform(sr, 4326))
# Free-flowing rivers
ffr_in <- "C:\\Users\\user\\Documents\\Articles\\gis_layers\\hydro_data\\sa_FFR_river_v1\\sa_FFR_river_v1.shp"
ffr_3395 <- st_read(ffr_in) |> 
  st_crop(crop_bbox) |> st_transform(3395)
ffr_3395$myval <- 1
```


```{r}
# project for costdist analysis
# reclass b4 transform
pd_rc <- ifel(pd >= 5, 10, 0)
pd_3395 <- project(pd_rc, method = "near","epsg:3395")
rm(pd)
rm(pd_rc)
# rasterize rivers.Five minutes....
pd_3395c <- pd_3395
pd_3395c <- ifel(!is.na(pd_3395),0 , NA)
r_ffr <- rasterize(vect(ffr_3395), pd_3395c, field = "myval", 
                   update = TRUE, touches = TRUE)
r_ffr <- ifel(is.na(r_ffr), 1, r_ffr)
# prep cost-distance
rf <- r_ffr + ifel(is.na(pd_3395), 0, pd_3395)
rf <- ifel(rf == 0, NA, rf)
rf <- ifel(rf >= 10, 0, rf) 
# cost-distance
cd_access <- costDist(rf, scale = 1000)
names(cd_access) <- "cost_distance"
cd_map <- ifel(cd_access >= 48, 0, 1)
names(cd_map) <- "access_new"

# save for future use.
writeRaster(cd_access, "inst/raster/cost_distance.tif", 
              gdal=c("COMPRESS=DEFLATE"), overwrite = TRUE)
writeRaster(cd_map, "inst/raster/access_new.tif", 
              gdal=c("COMPRESS=DEFLATE"), overwrite = TRUE)
```

## Final results

Overlay original point locations and new access map based on Free-flowing rivers.
Need to interpolate to fill in where original points do not touch 
Free-flowing rivers at 931 m scale......

```{r make-final-res}
sr_3395 <- vect(st_transform(sr, 3395))
access_new <- rast("inst/raster/access_new.tif") # 3395
sr_new <- st_as_sf(extract(access_new, sr_3395, bind = TRUE))
# 275622 NAs. Was 284313 NAs
summary(sr_new$access_new)
# Less NA in Accessible and not Protected - which is majority of river lengths.
# So will inflate contribution of accessible and unprotected i.e. areas 
# with population declines.
sr_new |> data.frame() |> 
  group_by(Accessible, Protected) |> 
  summarise(river_length = n(), 
            count_na = sum(is.na(access_new))) |> 
  ungroup() |> 
  mutate(prop_na = count_na / river_length)

sr_new |> data.frame() |> 
  group_by(Protected, access_new) |> 
  summarise(river_length = n()) |> 
  ungroup()
```


