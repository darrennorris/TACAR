---
title: "Population change map"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Interactive-map}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

<!-- Google Translate widget -->
<div id="google_translate_element" style="float: right;"></div>
<script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en', includedLanguages: 'ar,bn,pt,en,nl,es,fr,de,it,iw,hi,ja,ko,zh-CN'}, 'google_translate_element');
}
</script>
<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>


```{r setup, echo=FALSE}
library(TACAR)
```


```{r load-packages, echo=FALSE, message=FALSE, warning=FALSE}
library(plyr)
library(dplyr)
library(ggplot2)
library(leaflet)
library(leafem)
library(Hmisc)
library(sf)
library(knitr)
library(kableExtra)
library(htmltools) 
library(patchwork)
```

```{r main-result, echo=FALSE, message=FALSE, warning=FALSE}
fin <- system.file("other/scenario_res_ffr1a5.rds", package = "TACAR")
scenario_ffr_res <- readRDS(fin)
# Make factors
scenario_ffr_res$model_namef <- factor(scenario_ffr_res$model_name)
#levels(scenario_ffr_res$model_namef)
scenario_ffr_res$model_namef <- relevel(scenario_ffr_res$model_namef, ref = "modelkey_pessimistic")
scenario_ffr_res$modelidf <- factor(scenario_ffr_res$modelid)

df_country_basin <- scenario_ffr_res |> 
  #dplyr::filter(BASIN_NAME == "Coastal North") |> # track why have 1 Coastal South
  dplyr::mutate(modelidf = forcats::fct_reorder(modelidf, lambda_mean), 
                basin_country = paste(BASIN_NAME, COUNTRY, sep ="\n")) |> 
  dplyr::group_by(basin_country, COUNTRY, BASIN_NAME, 
                  model_namef) |> 
  dplyr::summarise(acount = dplyr::n(), 
                   tot_t0 = sum(fem_t0),
                   diff_t35 = (sum(fem_t35) - sum(fem_t0)) / sum(fem_t0),
                   diff_t41 = (sum(fem_t41) - sum(fem_t0)) / sum(fem_t0), 
                   diff_t45 = (sum(fem_t45) - sum(fem_t0)) / sum(fem_t0) 
  ) |> dplyr::ungroup() |> 
  dplyr::filter(acount > 21) |>
  tidyr::pivot_longer(cols = starts_with("diff_"), names_to = "gen_t3", 
                      values_to = "fem_diff")

# Weighted interqantile range
mean_wt <- Hmisc::wtd.mean(x = df_country_basin$fem_diff, 
                              w = df_country_basin$acount)
iqr_wt_25 <- Hmisc::wtd.quantile(x = df_country_basin$fem_diff, 
                              w = df_country_basin$acount, probs = 0.25)
iqr_wt_75 <- Hmisc::wtd.quantile(x = df_country_basin$fem_diff, 
                              w = df_country_basin$acount, probs = 0.75)
change_value <- round(abs(mean_wt) * 100, 1)
change_q25 <- round(abs(iqr_wt_25) * 100, 1)
change_q75 <- round(abs(iqr_wt_75) * 100, 1)

```

Use the interactive map below to check population changes. Zoom in to see 
where *Podocnemis unifilis* is Endangered based on IUCN Red List criteria - A3bd.

- Overall *Podocnemis unifilis* is Endangered ("Em perigo" / "En peligro") 
based on future population size reduction criteria - A3bd.    
Within 3 generations (35 years) the adult female population is predicted 
to decline by `r change_value`% in the future (25 and 75% quantile 
range: `r change_q25` - `r change_q75` % decline). 

## Map
If you find any errors (e.g. points where *Podocnemis unifilis* does not occur, 
points where species is "Endangered" but populations are increasing etc) 
please raise an issue at: https://github.com/darrennorris/TACAR/issues . 

```{r make-map-ffr, echo=FALSE, message=FALSE, warning=FALSE}
points_bau4326 <- sf::st_as_sf(points_bau_ffr_map, crs = 3395) |> 
  st_transform(4326) 
levels(points_bau4326$flag_50_35y) <- c("No", "Yes")
points_bau4326_low <- points_bau4326
# label to plot with circle
points_bau4326_low$label <- paste("Prot = ", points_bau4326_low$Protected, 
                                  "Acc = ", points_bau4326_low$Accessible, 
                                  "Free = ", points_bau4326_low$Free_flowing)
# colour palette
leaf_pal <- colorFactor(
  palette = c("#7274C1", "#A3720E"), 
  domain = points_bau4326$flag_50_35y
)

mypal <- c("#7274C1", "#A3720E")

# interactive map. Options added to make panning smoother....
leaflet::leaflet(points_bau4326_low, 
                 options = leafletOptions(preferCanvas = TRUE)) |> 
  addTiles(options = tileOptions(
  updateWhenZooming = FALSE,      # map won't update tiles until zoom is done
  updateWhenIdle = TRUE)) |> 
  addCircles(color = ~leaf_pal(flag_50_35y), 
             popup = ~htmlEscape(label),
             group = "points_bau4326_low"
) |>  
  addCircleMarkers(color = ~leaf_pal(flag_50_35y), 
             stroke = FALSE, fillOpacity = 0.4, 
clusterOptions = markerClusterOptions(), 
group = "points_bau4326"
) |> 
  addLegend("bottomright", pal = leaf_pal, title="Endangered",
            values = ~flag_50_35y,
            group = "en_legend") |> 
  groupOptions("points_bau4326", zoomLevels = 1:7) |> 
  groupOptions("points_bau4326_low", zoomLevels = 8:15) |> 
  groupOptions("en_legend", zoomLevels = 8:15) |> 
  addScaleBar() |> 
  leafem::addMouseCoordinates()
  
```

 - When you zoom in you will see shaded points.    
 The points are brown where populations are predicted to decline by 50% 
or more within 3 generations (35 years). Brown points therefore represent 
rivers where the species is Endangered ("Em perigo" / "En peligro"), 
following the IUCN Red List population size reduction criteria - A3bd 
(https://www.iucnredlist.org/about/faqs).

 - The points follow rivers mapped by remote sensing. 
This standardized global scale mapping comes from 
Grill et al 2019, Free-flowing Rivers: https://doi.org/10.1038/s41586-019-1111-9. 
The points are locations along rivers selected to represent where 
*Podocnemis unifilis* females are likely to nest and that are likely 
to be accessible to people by boat. To facilitate online viewing the mapped 
points are a subset at intervals of approximately 10 kilometers. 

 - Due to the number of points, the map can become slow to respond when you zoom in.    
 If this happens, zoom out to a level showing fewer points and you can pan around the map 
to find the area of interest. Then zoom in again to check the coloured points.

 - This is a conservative (best-case) estimate.    
 Endangered (A3bd), is threfore a precautionary IUCN Red List assessment.    
      - Important threats are not included (e.g. land use change). 
      - Losses are potentially buffered by an overly generous 20% ceiling to increases in unaccesible populations.
      - Population projections use the earliest likely breeding age. 
      - Hunting of adult females was limited to 10% per year in the most pessimistic scenarios.
      - HUnting accessibility was limited to a distance of 50 km. This will underestimate impacts associated with threats such as large scale harvest around urban areas (Chaves et. al. 2021).
 
## Methods
The analysis is developed here: https://github.com/darrennorris/TACAR, 
The methods used are an extension of [Norris et. al. 2019](https://doi.org/10.1016/j.biocon.2019.02.022) that includes:

- Stochastic population projections. 
- Future impacts to populations caused by human acessibility (hunting) and actions that reduce river connectivity.
