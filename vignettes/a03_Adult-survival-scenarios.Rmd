---
title: "Adult survival scenarios"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Adult survival scenarios}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(TACAR)
library(ggplot2)
library(popdemo)
```

Establish distribution of plausible adult survival values in the 
following scenarios: 

 - Unharvested, with and without recovery actions.
 - Lightly harvested, with and without recovery actions.
 - Intesively harvested, with and without recovery actions.
 
 To be able to compare with and without recovery actions we need to 
 include density dependence in the matrix projection models.
 
 We use estimates of longevity to establish mean and range of annual 
 adult female survival in populations for each scenario. 
 This is then used to estimate the distribution  "today", 
 before considering the effect of future actions (either positive e.g. 
 recovery or negative e.g. continued harvest).

 - Unharvested,    
 mean 57.1 years, range 20 to 70 years, beta distribution.
 
 - Lightly harvested (less than 2.5% per year),    
 mean 30 years, range 20 to 70 years, beta distribution.
 
 - Intensively harvested (greater than 5% per year),    
 mean 22 years, range 20 to 70 years, half-normal distribution.
 
```{r survival-distributions}
adult_survival <- TACAR::make_beta(survival_mean = 0.976987, 
                                      survival_min = 0.9215, 
                                      survival_max = 0.98153, 
                                   alpha = 40, beta = 40
                                   )
hist(adult_survival$within_range, probability = TRUE)
mean(adult_survival$within_range, na.rm = TRUE)

adult_survival_hunt_low <- TACAR::make_beta(survival_mean = 0.95244, 
                                      survival_min = 0.9215, 
                                      survival_max = 0.98153, 
                                   alpha = 400, beta = 400
                                   )
hist(adult_survival_hunt_low$within_range, probability = TRUE)
mean(adult_survival_hunt_low$within_range, na.rm = TRUE)

adult_survival_hunt_high <- TACAR::make_half_normal(survival_mean = 0.96,
                                                    survival_min = 0.92, 
                                                    survival_max = 0.97339)
# Plot the distribution
hist(adult_survival_hunt_high$survival_values, probability = TRUE)
mean(adult_survival_hunt_high$survival_values, na.rm = TRUE)

```

Compare the survival in populations under different hunting pressure.

```{r plot-density, message=FALSE, warning=FALSE}
df_survival <- rbind(
data.frame(distribution = "beta", hunt_level = "a_none", 
           female_survival = adult_survival$within_range),
data.frame(distribution = "beta", hunt_level = "b_low", 
           female_survival = adult_survival_hunt_low$within_range),
data.frame(distribution = "beta", hunt_level = "c_high", 
           female_survival = adult_survival_hunt_high$survival_values) 
)
df_survival$hunt_levelf <- factor(df_survival$hunt_level)
levels(df_survival$hunt_levelf) <- c("none", "low", "high")

# Plot
mylabels <- c("0.92\n(19.7 Y)", "0.94\n(24.8 Y)", "0.96\n(34.8 Y)", 
              "0.98\n(64.0 Y)")
ggplot(data = df_survival, aes(x = female_survival, 
                               group = hunt_levelf, fill = hunt_levelf)) + 
  geom_density(alpha = 0.5, adjust = 2) + 
  scale_fill_viridis_d("harvest") + 
  scale_x_continuous(breaks = c(0.92, 0.94, 0.96, 0.98), 
                     labels = mylabels) +
  xlab("Female survival") +
  ylab("Density")

```

The figure shows the distribtution of adult female survival in 
populations under threee different scenarios. The x axis shows 
survival values with overall life expectancy in parentheses.

 
We can now use these distributions to explore how the populations are 
likely to change in the future. Here we follow the element selection 
example: 
https://cran.r-project.org/web/packages/popdemo/vignettes/popdemo.html#72_Nonrandom_matrix_selection

```{r project-survival}
# get matrix
# projection parameters
dt <- TACAR::pop01_param_poun()
# Population size constant.
nf <- 10
dt$adultF_n <- nf

# No data on density dependence for any South American freshwater turtle.
# Here include a generous 20% ceiling on maximum population increase 
# in the case of harvested populations.
ceiling_threshold_high <- ceiling(nf + (nf * 0.2))
ceiling_threshold_low <- ceiling(nf + (nf * 0.1))
ceiling_threshold_none <- ceiling(nf + (nf * 0.05))

# Matrix from data.frame
stage_names <- c("a1", "a2", "a3", "a4",
                   "b1", "b2", "b3", "b4",
                   "c1", "c2", "c3", "c4",
                   "d1", "d2", "d3", "d4")
vpop <- unlist(dt[3 , stage_names])
pop_mat <- matrix(vpop, byrow = TRUE, ncol=4)
dimnames(pop_mat) <- list(c("_1", "_2", "_3", "_4"),
                            c( "a", "b", "c", "d"))
  # stable stage structure
  pop_ss <- popdemo::eigs(pop_mat, "ss")
  # stable stage population numbers corresponding to number of females
  pop_n <-  nf * (pop_ss * (1/pop_ss[4]))
#create list of 100 matrices
ntimes <- 100
pop_mat_100 <- rep(list(pop_mat), ntimes)
#replace [d, 4] element of every matrix with new random number
a44 <- sample(adult_survival_hunt_high$survival_values, size = ntimes)
# 5% harvest
a44 <- (a44 - (a44 * 0.05))
pop_mat_100 <- mapply(function(A, r){A[4, 4] <- r; A}, pop_mat_100, a44, 
                      SIMPLIFY = FALSE)
pop_mat_high <- pop_mat
pop_mat_high[4, 4] <- (pop_mat[4, 4] - (pop_mat[4, 4]*0.05))
# Project and plot
poun_high <- popdemo::project(pop_mat_100, vector = pop_n, Aseq = 1:ntimes)
plot(poun_high, log = "y")
lines(0:ntimes, project(pop_mat_high, pop_n, time = ntimes), lty = 3)
```


