---
title: "Join river and population data"
author: "Darren Norris"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Objective
Integrate point locations and population projections.

Specifically: 

- Join with free flowing rivers. 
- Join point scenarios with population projections.
- Generate data used for summaries. 
- Make summaries.
- Create results for presentation.

## Packages
```{r load-packages, warning=FALSE, message=FALSE}
library(plyr)
library(tidyverse)
library(readxl)
library(sf)
library(patchwork)
```

Check what attributes were in cmartr version made using "Old_RiverlengthSummary.R".
Missing country and other basin details.
Add free flowiong river data to points.
Spatial join. Get country, CSI_FF.
 
REACH_ID Reach Identifier. The reach identifier can be used to link 
this dataset to the HydroATLAS database.
COUNTRY
BAS_ID Basin Identifier. Identifies the hydrological river basin 
according to the HydroSHEDS framework.
BAS_NAME  Basin Name (if available).
RIV_ORD River order. River order is here defined and calculated based 
on the long-term average discharge (DIS_AV_CMS) using logarithmic progression:
1 = > 100000
2 = 10000 – 100000
3 = 1000 – 10000
4 = 100 – 1000
5 = 10 – 100
Connectivity Status Index CSI above or below free-flowing threshold.
Indicates if the CSI value of a river reach is below (value = 0) or 
above (value = 1) the threshold of 95%.

Updated for Amazon to 92% 2023 - https://doi.org/10.1111/csp2.12853.

```{r load-river, eval=FALSE}
# Free flowing rivers for unifilis.
pounf <- "C:\\Users\\user\\Documents\\IUCN_redgreen\\IUCN_greenstatus\\analysis\\vector\\poun_presence.gpkg"
basins_ffr_3395 <- read_sf(pounf, layer = "basins_ffr") |> st_transform(3395)

# Get points from cmartr.
dir <- "C:\\Users\\user\\Documents\\Articles\\2024_Norris_Greenstatus\\TACAR\\inst\\vector\\shapes_rivers3395"
ff <- list.files(dir, pattern="\\.shp$", full.names=TRUE)
df_points <- data.frame(points_file = ff)

# load points made previously in prep_river_points.Rmd. RIVORD 1 to 5. 
# Cropped to basins from Norris et. al. 2019.
# infile <- "C:\\Users\\user\\Documents\\Articles\\2024_Norris_Greenstatus\\TACAR\\inst\\vector\\poun_river_points.gpkg"
# ffr_1a4_poun_points_3395 <- st_read(dsn = infile, 
#                                    layer = "ffr_1a4_poun_points_3395")
infile <- "C:\\Users\\user\\Documents\\Articles\\2024_Norris_Greenstatus\\TACAR\\inst\\vector\\poun_river_points_v2.gpkg"
ffr_1a5_poun_points_3395 <- st_read(dsn = infile, 
                                    layer = "ffr_1a5_poun_points_3395")
```

Now join.
```{r spatial-join}
# function to join
join_ffr <- function(x){
rpin <- x
points_3395 <- read_sf(rpin) |> st_transform(3395)
# crop to speed up processing.
ffr_crop <- st_crop(basins_ffr_3395, st_bbox(points_3395))
# join
join_sf <- st_join(points_3395, ffr_crop, join = st_nearest_feature)
dout <- join_sf |> 
  select(BASIN_NAME, subbasin, SUBBASIN_FLAG, All, accessible, COUNTRY, BAS_NAME, 
         RIV_ORD, BB_ID, BB_NAME, REACH_ID, CSI, CSI_FF) |> 
  data.frame()
return(dout)
}
# 3 minutes
tout <- plyr::adply(df_points, 
                    .margins = 1, .fun = join_ffr)
# Check
table(tout$BASIN_N)
table(tout$subbasn)
table(tout$SUBBASI)
tout |> 
  group_by(BASIN_N, subbasn, SUBBASI) |> 
  summarise(acount = n())
```

## Join with scenarios

Load projection model lookup table.
```{r load-lookup}
# model_lookup has 300 population projections created in "test_projections.Rmd".
model_lookup <- readRDS('inst/other/model_lookup.rds')
# actions has scenarios with associated projection models
actions <- readxl::read_excel("inst/other/Podocnemis conservation actions.xlsx", 
                      sheet = "scenario_parameters", .name_repair = "universal")
```

### Projections based on current situation
```{r join-scenarios}
# Join model results to scenarios
scenario_res <- tout |> data.frame() |> 
  #filter(subbasn == "Trombetas") |>
  mutate(Protected = if_else(All == 1, "yes", "no"), 
         Accessible = if_else(accessible == "No", "no", "yes"), 
         Free.flowing = if_else(CSI_FF == 1, "yes", "no")
         ) |> left_join( 
           actions |> 
  filter(Podocnemis.modelling.scenario == "Protection") |> 
  pivot_longer(cols = starts_with("modelkey"), names_to = "model_name", 
               values_to = "modelkey") |> 
  left_join(model_lookup, by = join_by(modelkey == modelkey) 
            ), 
  by = c("Protected" = "Protected", "Accessible" = "Accessible", 
         "Free.flowing" = "Free.flowing"), 
  relationship = "many-to-many"
           ) |> 
  filter(!is.na(lambda_mean)) |> # where points do not overlap new basins
  mutate(flag_b = paste(BASIN_N, SUBBASI, sep="_"))
# should be zero rows if join worked. 
test_join <- scenario_res |> 
  filter(is.na(lambda_mean)) |> nrow()
# check counts match
tout |> 
  group_by(BASIN_N, subbasn) |> summarise(acount = n())
scenario_res |> 
  group_by(BASIN_N, subbasn, model_name) |> summarise(acount = n())

# export for futher use
saveRDS(scenario_res, "inst/other/scenario_res_current.rds")

# Now with free-flowing river points.  RIV ORD 1 to 5. 
# Cropped to basins from Norris et. al. 2019.
# Here 3 versions - modelkey pess, BAU, optimistic.
### 1060311 rows 6/8/2024
scenario_ffr_res <- ffr_1a5_poun_points_3395 |> data.frame() |> 
  #filter(subbasn == "Trombetas") |>
  mutate(Protected = if_else(All == 1, "yes", "no"), 
         Protected_cat = case_when(Indigenous == 1 ~ "TI", 
                                   Strict == 1 ~ "SP", 
                                   myuse == 1 ~ "SU", 
                                   .default = "no"
                                   ), 
         Accessible = if_else(access_new == 0, "no", "yes"), 
         Free_flowing = if_else(CSI >= 0.92, "yes", "no")
         ) |> left_join( 
           actions |> 
  filter(Podocnemis.modelling.scenario == "Protection") |> 
  pivot_longer(cols = starts_with("modelkey"), names_to = "model_name", 
               values_to = "modelkey") |> 
  left_join(model_lookup, by = join_by(modelkey == modelkey) 
            ), 
  by = c("Protected" = "Protected", "Protected_cat" = "Protected_cat", 
         "Accessible" = "Accessible", 
         "Free_flowing" = "Free_flowing"), 
  relationship = "many-to-many"
           ) |> 
  filter(!is.na(lambda_mean)) |> # where points do not overlap new basins
  mutate(flag_b = paste(BASIN_NAME, subbasin, sep="_"))
# should be zero rows if join worked. 
test_join <- scenario_ffr_res |> 
  filter(is.na(lambda_mean)) |> nrow()

saveRDS(scenario_ffr_res, "inst/other/scenario_res_ffr1a5.rds")
```

Make summaries for plotting.
```{r make-plot-summary}
# summary
sum_diff_mean <- scenario_res |> 
  mutate(flag_50_42y = factor(if_else(fem_diff_t42 <= -0.5, 1, 0))) |>
  group_by(BASIN_N, subbasn, SUBBASI, Protected, Accessible, Free.flowing, 
           model_name, flag_50_42y) |> 
  summarise(river_length = n(), 
            lambda = mean(lambda_mean), 
            diff_42y = mean(fem_diff_t42)) |> 
  ungroup() 
sum_diff_q25 <- scenario_res |> 
  mutate(flag_50_42y = factor(if_else(fem_diff_q25_t42 <= -0.5, 1, 0))) |>
  group_by(BASIN_N, subbasn, SUBBASI, Protected, Accessible, Free.flowing, 
           model_name, flag_50_42y) |> 
  summarise(river_length = n(), 
            lambda = mean(lambda_q25), 
            diff_42y = mean(fem_diff_q25_t42)) |> 
  ungroup() 
sum_diff_q75 <- scenario_res |> 
  mutate(flag_50_42y = factor(if_else(fem_diff_q75_t42 <= -0.5, 1, 0))) |>
  group_by(BASIN_N, subbasn, SUBBASI, Protected, Accessible, Free.flowing, 
           model_name, flag_50_42y) |> 
  summarise(river_length = n(), 
            lambda = mean(lambda_q75), 
            diff_42y = mean(fem_diff_q75_t42)) |> 
  ungroup() 
# Join and add percentages
tot_km <- tout |> 
  group_by(BASIN_N, subbasn, SUBBASI) |> 
  summarise(river_tot = n()) |> ungroup()
sum_diff <- bind_rows(sum_diff_mean |> mutate(scen_est = "mean"), 
                      sum_diff_q25 |> mutate(scen_est = "lower"), 
                      sum_diff_q75 |> mutate(scen_est = "upper")) |> 
  left_join(tot_km)|>
  mutate(river_prop = river_length / river_tot)
# Factor levels follow sequence worst to best case
sum_diff$model_namef <- factor(sum_diff$model_name)
sum_diff$model_namef <- relevel(sum_diff$model_namef, ref = "modelkey_pessimistic")
levels(sum_diff$model_namef) <- c("pessimistic", "BAU", "optimistic") 
sum_diff$model_cat <- factor(paste(sum_diff$flag_50_42y, sum_diff$scen_est, sep = ""))

# export for further use
saveRDS(sum_diff, "inst/other/sum_diff_current.rds")
```


## Make figures 

Colourblind friendly pallette.
```{r final-palette}
myfillhex3 <- c("#DADCFF", "#B7B8F0", "#8385CD", 
                "#F6DABF", "#D0A570", "#B28339" 
                )
```

The colour palette was chosen using the following.
```{r make-palette, eval=FALSE}
# function to help checking
# https://hiweller.rbind.io/post/using-the-dichromat-package-to-check-if-your-plot-is-colorblind-friendly/
check_cb <- function(palette, return_cb_palettes = FALSE, ...) {
  
  # make an empty list
  cb_palettes <- setNames(vector("list", length = 3), 
                          nm = c("protan", "deutan", "tritan"))
  
  # generate colorblindness approximations
  for (i in 1:length(cb_palettes)) {
    cb_palettes[[i]] <- dichromat::dichromat(palette, names(cb_palettes)[i])
  }
  
  # reset graphical parameters when function exits:
  current_par <- graphics::par(no.readonly = TRUE)
  on.exit(graphics::par(current_par))
  
  # plot for comparison
  layout(matrix(1:4, nrow = 4)); par(mar = rep(1, 4))
  recolorize::plotColorPalette(palette, main = "Trichromacy", ...)
  pnames <- c("Protanopia", "Deutanopia", "Tritanopia")
  for (i in 1:3) {
    recolorize::plotColorPalette(cb_palettes[[i]], main = pnames[i], ...)
  }

  if (return_cb_palettes) {
    return(cb_palettes)
  }
}

# palettes
myfill <- c("lightsteelblue" ,"mediumpurple1", "mediumpurple3",
              "indianred3", "firebrick", "#832424") 
myfillhex <- c("#B0C4DE", "#AB82FF", "#8968CD", 
              "#CD5555", "#B22222", "#832424")
myfillhex2 <- c("#B0C4DE", "#AB82FF", "#8968CD", 
              "#CD5555", "#B22222", "#661100")
library(wacolors)
pal_vector("lopez", 15)
PAL_LOPEZ <- c("#A3720E", "#B28339", "#C09355", "#D0A570", "#DEB688",
               "#EBC7A3", "#F6DABF", "#F1F1F1", "#DADCFF", "#C9CAF9",
               "#B7B8F0", "#A5A6E5", "#9396D9", "#8385CD", "#7274C1")
myfillhex3 <- c("#DADCFF", "#B7B8F0", "#8385CD", 
                "#F6DABF", "#D0A570", "#B28339" 
                )
# check
check_cb(myfillhex) # not great!!
check_cb(myfillhex2) # not great!!
# this gives good contrast across all
check_cb(myfillhex3)

```


Expected change over 42 years.
Make maps seperately.
```{r make-maps}
# set scale values to be consistent across all maps - ensures only one 
# scale with patchwork.
col_min <- min(scenario_res$fem_diff_t42, na.rm = TRUE)
col_max <- max(scenario_res$fem_diff_t42, na.rm = TRUE)
# function to make ggplot maps for all subbasins
make_maps <- function(x){ 
# Try to use bbox for breaks as I am squishing maps in final figures.
inp <- x
mybbox <-  st_bbox(st_as_sf(inp) |> st_transform(4326))
myxmin <- ceiling(mybbox["xmin"])
myxmax <- floor(mybbox["xmax"])
xdiff <- myxmax - myxmin
myymin <- ceiling(mybbox["ymin"])
myymax <- floor(mybbox["ymax"])
ydiff <- myymax - myymin
# scale options based on how big subbasin is
if(xdiff <= 2){
  breaks_x = myxmax
} else if (xdiff == 3){ 
  breaks_x = c(seq(myxmin, myxmax, by = 2)) 
} else { 
  tq <- quantile(seq(myxmin, myxmax, by = 1), probs = c(0.25, 0.75))
  tmin <- ceiling(tq["25%"])
  tmax <- floor(tq["75%"]) 
  breaks_x = c(tmin, tmax)
}
# y axis
if(ydiff <= 2){
  breaks_y = myymax
} else if (ydiff == 3){ 
  breaks_y = c(seq(myymin, myymax, by = 2)) 
} else { 
  tq <- quantile(seq(myymin, myymax, by = 1), probs = c(0.25, 0.75))
  tmin <- floor(tq["25%"])
  tmax <- ceiling(tq["75%"]) 
  breaks_y = c(tmin, tmax)
      }
fig_map <- inp |> 
  filter(model_name == "modelkey_BAU") |>
  st_as_sf() |>
  ggplot() +
  geom_sf(aes(colour = fem_diff_t42), size = 0.6) + 
  scale_x_continuous(breaks = breaks_x) + 
  scale_y_continuous(breaks = breaks_y) +
  scale_colour_gradient2("BAU\nchange", limits = c(col_min, col_max),
                         low = "#A3720E", mid = "white", 
                         high = "#7274C1", midpoint = 0) + 
  theme_bw()
ba <- paste(x[1, 'BASIN_N'], "_", x[1, 'SUBBASI'], sep = "")
dir_name <- "inst/other/fig_rds"
fig_name <- paste("map_t42_", ba, ".rds", sep = "")
fig_out <- paste(dir_name, fig_name, sep = "/")
# export
saveRDS(fig_map, fig_out)
}
# values mapped for each subbasin
plyr::d_ply(scenario_res, .variables = c("flag_b"),
                     .fun = make_maps)
```


## Make results
Make manually to plot across pages.

### Load data
Here we load data created previously.
First dataframes with projection values.
```{r load-data}
sum_diff_current <- readRDS("inst/other/sum_diff_current.rds")
scenario_res_current <- readRDS("inst/other/scenario_res_current.rds")
```

Now load ggplot maps showing spatial patterns in projected changes, 
created previously.
```{r load-maps}
# load .rds holding ggplot objects. Takes a few minutes.
# Need to include SUBBASI in sum_diff
dirrds <- "C:\\Users\\user\\Documents\\Articles\\2024_Norris_Greenstatus\\TACAR\\inst\\other\\fig_rds"
ffrds <- list.files(dirrds, pattern="\\.rds$", full.names=TRUE)
# Make a vector of file names
file_names <-  gsub(pattern = "\\.rds$", replacement = "", x = basename(ffrds))
# Dataframe for selecting/joining
dfref <- data.frame(apath = ffrds, aname = file_names) |> 
  separate_wider_delim(aname, "_", names = c("a", "b", "BASIN_N", "SUBBASI"), 
                       cols_remove = FALSE) |> 
  select(!c(a, b)) |> 
  left_join(scenario_res_current |> 
              group_by(BASIN_N, SUBBASI, subbasn) |> 
              summarise(acount = n()) |> 
              mutate(SUBBASI = as.character(SUBBASI)) |>
              ungroup()) |> 
  select(!acount) |> 
  arrange(BASIN_N, subbasn)
# Amazon (n=27) = 6 pages , Coastal North (n=21) = 5 pages 
# Coastal South = 1 (n=1), Orinoco = 1 (n=3) 
dfref |> 
  group_by(BASIN_N) |> 
  summarise(count_sub = length(unique(subbasn)), 
            count_subi = length(unique(SUBBASI)))
```

### Amazon

#### Page 1

Now make figures.
```{r make-groupsp1, echo=FALSE, warning=FALSE, message=FALSE}
# Apply same sequence to data and maps.
sid <- dfref |> 
  filter(BASIN_N == "Amazon") |> pull(subbasn)
n_perpage <- 7
to_use <- dfref |> 
  filter(subbasn %in% sid[1:(n_perpage * 1)])
# Read into a list
fig_42_list <- lapply(to_use$apath, readRDS)
# Assign file names to list elements
names(fig_42_list) <- to_use$aname  
# values to plot. Check this as myabe summarise is not necessary.
dfplot <- sum_diff_current |> 
  filter(subbasn %in% to_use$subbasn) |>
  group_by(BASIN_N, subbasn, model_namef, scen_est, model_cat, flag_50_42y) |> 
  summarise(rl = sum(river_length), 
            rl_prop = round(sum(river_length) / river_tot, 3),
            ml = mean(lambda), 
            maxl = max(lambda), 
            minl = min(lambda)) |> 
   ungroup()
# Proportion of rivers with Endangered populations
fig_bar_42_prop <- dfplot |> 
ggplot(aes(x = flag_50_42y, y = rl_prop)) + 
  geom_col(aes(group = scen_est, fill = model_cat), position = "dodge") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", colour = "black") +
  scale_fill_manual(values = rep(myfillhex3, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(limits = c(0, NA), breaks = c(0, 0.5, 1), 
                     labels = c("", "0.5", "1.0")) + 
  labs(y = "river proportion", x = "Endangered (50% loss)") + 
  #coord_flip() + 
  facet_grid(BASIN_N + subbasn ~ model_namef) + 
  theme_bw() +
  theme(legend.position="none")
# Population growth
fig_bar_42_lambda <- dfplot |> 
ggplot(aes(x = flag_50_42y, y = ml)) + 
  geom_linerange(aes(group = interaction(scen_est, model_cat), 
                    ymin = minl, ymax = maxl), 
                position=position_dodge(.9)) +
  geom_point(aes(group = scen_est, colour = model_cat), 
                position=position_dodge(.9)) +
  geom_hline(yintercept = 1.0, linetype = "dashed", colour = "black") +
  scale_colour_manual(values = rep(myfillhex3, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(breaks = c(0.8, 0.9, 1)) + 
  labs(y = "population growth rate (lambda)", x = "Endangered (50% loss)") + 
  #coord_flip() + 
  facet_grid(BASIN_N + subbasn ~ model_namef) + 
  theme_bw() +
  theme(legend.position="none")

# save plot
# file name
ba <- paste(to_use[1, 'BASIN_N'], "_", to_use[1, 'SUBBASI'], sep = "")
dir_name <- "inst/other"
fig_name <- paste("fig_t42_", ba, ".png", sep = "")
fig_out <- paste(dir_name, fig_name, sep = "/")
# save
png(file = fig_out, bg = "transparent", 
    type = c("cairo"), 
    width = 9, height = 11, units = "in", res=600)
((fig_bar_42_prop + fig_bar_42_lambda) +
(patchwork::wrap_plots(fig_42_list, ncol = 1, nrow = n_perpage, 
                      widths = c(rep(1, n_perpage)), 
                      heights = c(rep(1, n_perpage)), 
                      guides = "collect"))) +
  plot_annotation("Population change 42 years (3 generations lower estimate)", 
                  tag_levels = list(c("A", "B", "C", "", "", "", ""))) + 
  plot_layout(widths = c(6, 6, 3)) 
invisible(dev.off())
```

#### Page 2

```{r make-groupsp2, echo=FALSE, warning=FALSE, message=FALSE}
# Apply same sequence to data and maps.
sid <- dfref |> 
  filter(BASIN_N == "Amazon") |> pull(subbasn)
n_perpage <- 7
to_use <- dfref |> 
  filter(subbasn %in% sid[8:(n_perpage * 2)])
# Read into a list
fig_42_list <- lapply(to_use$apath, readRDS)
# Assign file names to list elements
names(fig_42_list) <- to_use$aname  
# values to plot. Check this as myabe summarise is not necessary.
dfplot <- sum_diff_current |> 
  filter(subbasn %in% to_use$subbasn) |>
  group_by(BASIN_N, subbasn, model_namef, scen_est, model_cat, flag_50_42y) |> 
  summarise(rl = sum(river_length), 
            rl_prop = round(sum(river_length) / river_tot, 3),
            ml = mean(lambda), 
            maxl = max(lambda), 
            minl = min(lambda)) |> 
   ungroup()
# Proportion of rivers with Endangered populations
fig_bar_42_prop <- dfplot |> 
ggplot(aes(x = flag_50_42y, y = rl_prop)) + 
  geom_col(aes(group = scen_est, fill = model_cat), position = "dodge") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", colour = "black") +
  scale_fill_manual(values = rep(myfillhex3, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(limits = c(0, NA), breaks = c(0, 0.5, 1), 
                     labels = c("", "0.5", "1.0")) + 
  labs(y = "river proportion", x = "Endangered (50% loss)") + 
  #coord_flip() + 
  facet_grid(BASIN_N + subbasn ~ model_namef) + 
  theme_bw() +
  theme(legend.position="none")
# Population growth
fig_bar_42_lambda <- dfplot |> 
ggplot(aes(x = flag_50_42y, y = ml)) + 
  geom_linerange(aes(group = interaction(scen_est, model_cat), 
                    ymin = minl, ymax = maxl), 
                position=position_dodge(.9)) +
  geom_point(aes(group = scen_est, colour = model_cat), 
                position=position_dodge(.9)) +
  geom_hline(yintercept = 1.0, linetype = "dashed", colour = "black") +
  scale_colour_manual(values = rep(myfillhex3, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(breaks = c(0.8, 0.9, 1)) + 
  labs(y = "population growth rate (lambda)", x = "Endangered (50% loss)") + 
  #coord_flip() + 
  facet_grid(BASIN_N + subbasn ~ model_namef) + 
  theme_bw() +
  theme(legend.position="none")

# save plot
# file name
ba <- paste(to_use[1, 'BASIN_N'], "_", to_use[1, 'SUBBASI'], sep = "")
dir_name <- "inst/other"
fig_name <- paste("fig_t42_", ba, ".png", sep = "")
fig_out <- paste(dir_name, fig_name, sep = "/")
# save
png(file = fig_out, bg = "transparent", 
    type = c("cairo"), 
    width = 9, height = 11, units = "in", res=600)
((fig_bar_42_prop + fig_bar_42_lambda) +
(patchwork::wrap_plots(fig_42_list, ncol = 1, nrow = n_perpage, 
                      widths = c(rep(1, n_perpage)), 
                      heights = c(rep(1, n_perpage)), 
                      guides = "collect"))) +
  plot_annotation("Population change 42 years (3 generations lower estimate)", 
                  tag_levels = list(c("A", "B", "C", "", "", "", ""))) + 
  plot_layout(widths = c(6, 6, 3)) 
invisible(dev.off())
```

#### Page 3

```{r make-groupsp3, echo=FALSE, warning=FALSE, message=FALSE}
# Apply same sequence to data and maps.
sid <- dfref |> 
  filter(BASIN_N == "Amazon") |> pull(subbasn)
n_perpage <- 7
to_use <- dfref |> 
  filter(subbasn %in% sid[15:(n_perpage * 3)])
# Read into a list
fig_42_list <- lapply(to_use$apath, readRDS)
# Assign file names to list elements
names(fig_42_list) <- to_use$aname  
# values to plot. Check this as myabe summarise is not necessary.
dfplot <- sum_diff_current |> 
  filter(subbasn %in% to_use$subbasn) |>
  group_by(BASIN_N, subbasn, model_namef, scen_est, model_cat, flag_50_42y) |> 
  summarise(rl = sum(river_length), 
            rl_prop = round(sum(river_length) / river_tot, 3),
            ml = mean(lambda), 
            maxl = max(lambda), 
            minl = min(lambda)) |> 
   ungroup()
# Proportion of rivers with Endangered populations
fig_bar_42_prop <- dfplot |> 
ggplot(aes(x = flag_50_42y, y = rl_prop)) + 
  geom_col(aes(group = scen_est, fill = model_cat), position = "dodge") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", colour = "black") +
  scale_fill_manual(values = rep(myfillhex3, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(limits = c(0, NA), breaks = c(0, 0.5, 1), 
                     labels = c("", "0.5", "1.0")) + 
  labs(y = "river proportion", x = "Endangered (50% loss)") + 
  #coord_flip() + 
  facet_grid(BASIN_N + subbasn ~ model_namef) + 
  theme_bw() +
  theme(legend.position="none")
# Population growth
fig_bar_42_lambda <- dfplot |> 
ggplot(aes(x = flag_50_42y, y = ml)) + 
  geom_linerange(aes(group = interaction(scen_est, model_cat), 
                    ymin = minl, ymax = maxl), 
                position=position_dodge(.9)) +
  geom_point(aes(group = scen_est, colour = model_cat), 
                position=position_dodge(.9)) +
  geom_hline(yintercept = 1.0, linetype = "dashed", colour = "black") +
  scale_colour_manual(values = rep(myfillhex3, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(breaks = c(0.8, 0.9, 1)) + 
  labs(y = "population growth rate (lambda)", x = "Endangered (50% loss)") + 
  #coord_flip() + 
  facet_grid(BASIN_N + subbasn ~ model_namef) + 
  theme_bw() +
  theme(legend.position="none")

# save plot
# file name
ba <- paste(to_use[1, 'BASIN_N'], "_", to_use[1, 'SUBBASI'], sep = "")
dir_name <- "inst/other"
fig_name <- paste("fig_t42_", ba, ".png", sep = "")
fig_out <- paste(dir_name, fig_name, sep = "/")
# save
png(file = fig_out, bg = "transparent", 
    type = c("cairo"), 
    width = 9, height = 11, units = "in", res=600)
((fig_bar_42_prop + fig_bar_42_lambda) +
(patchwork::wrap_plots(fig_42_list, ncol = 1, nrow = n_perpage, 
                      widths = c(rep(1, n_perpage)), 
                      heights = c(rep(1, n_perpage)), 
                      guides = "collect"))) +
  plot_annotation("Population change 42 years (3 generations lower estimate)", 
                  tag_levels = list(c("A", "B", "C", "", "", "", ""))) + 
  plot_layout(widths = c(6, 6, 3)) 
invisible(dev.off())
```

#### Page 4

```{r make-groupsp4, echo=FALSE, warning=FALSE, message=FALSE}
# Apply same sequence to data and maps.
sid <- dfref |> 
  filter(BASIN_N == "Amazon") |> pull(subbasn)
n_perpage <- 7
to_use <- dfref |> 
  filter(subbasn %in% sid[22:(n_perpage * 4)])
# Read into a list
fig_42_list <- lapply(to_use$apath, readRDS)
# Assign file names to list elements
names(fig_42_list) <- to_use$aname  
# values to plot. Check this as myabe summarise is not necessary.
dfplot <- sum_diff_current |> 
  filter(subbasn %in% to_use$subbasn) |>
  group_by(BASIN_N, subbasn, model_namef, scen_est, model_cat, flag_50_42y) |> 
  summarise(rl = sum(river_length), 
            rl_prop = round(sum(river_length) / river_tot, 3),
            ml = mean(lambda), 
            maxl = max(lambda), 
            minl = min(lambda)) |> 
   ungroup()
# Proportion of rivers with Endangered populations
fig_bar_42_prop <- dfplot |> 
ggplot(aes(x = flag_50_42y, y = rl_prop)) + 
  geom_col(aes(group = scen_est, fill = model_cat), position = "dodge") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", colour = "black") +
  scale_fill_manual(values = rep(myfillhex3, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(limits = c(0, NA), breaks = c(0, 0.5, 1), 
                     labels = c("", "0.5", "1.0")) + 
  labs(y = "river proportion", x = "Endangered (50% loss)") + 
  #coord_flip() + 
  facet_grid(BASIN_N + subbasn ~ model_namef) + 
  theme_bw() +
  theme(legend.position="none")
# Population growth
fig_bar_42_lambda <- dfplot |> 
ggplot(aes(x = flag_50_42y, y = ml)) + 
  geom_linerange(aes(group = interaction(scen_est, model_cat), 
                    ymin = minl, ymax = maxl), 
                position=position_dodge(.9)) +
  geom_point(aes(group = scen_est, colour = model_cat), 
                position=position_dodge(.9)) +
  geom_hline(yintercept = 1.0, linetype = "dashed", colour = "black") +
  scale_colour_manual(values = rep(myfillhex3, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(breaks = c(0.8, 0.9, 1)) + 
  labs(y = "population growth rate (lambda)", x = "Endangered (50% loss)") + 
  #coord_flip() + 
  facet_grid(BASIN_N + subbasn ~ model_namef) + 
  theme_bw() +
  theme(legend.position="none")

# save plot
# file name
ba <- paste(to_use[1, 'BASIN_N'], "_", to_use[1, 'SUBBASI'], sep = "")
dir_name <- "inst/other"
fig_name <- paste("fig_t42_", ba, ".png", sep = "")
fig_out <- paste(dir_name, fig_name, sep = "/")
# save
png(file = fig_out, bg = "transparent", 
    type = c("cairo"), 
    width = 9, height = 9, units = "in", res=600)
((fig_bar_42_prop + fig_bar_42_lambda) +
(patchwork::wrap_plots(fig_42_list, ncol = 1, nrow = nrow(to_use), 
                      widths = c(rep(1, nrow(to_use))), 
                      heights = c(rep(1, nrow(to_use))), 
                      guides = "collect"))) +
  plot_annotation("Population change 42 years (3 generations lower estimate)", 
                  tag_levels = list(c("A", "B", "C", "", "", "", ""))) + 
  plot_layout(widths = c(6, 6, 3)) 
invisible(dev.off())
```

### Coastal North

#### Page 5
```{r make-groupsp5, echo=FALSE, warning=FALSE, message=FALSE}
# Apply same sequence to data and maps.
sid <- dfref |> 
  filter(BASIN_N == "Coastal North") |> pull(subbasn)
n_perpage <- 7
to_use <- dfref |> 
  filter(subbasn %in% sid[1:(n_perpage * 1)])
# Read into a list
fig_42_list <- lapply(to_use$apath, readRDS)
# Assign file names to list elements
names(fig_42_list) <- to_use$aname  
# values to plot. Check this as myabe summarise is not necessary.
dfplot <- sum_diff_current |> 
  filter(subbasn %in% to_use$subbasn) |>
  group_by(BASIN_N, subbasn, model_namef, scen_est, model_cat, flag_50_42y) |> 
  summarise(rl = sum(river_length), 
            rl_prop = round(sum(river_length) / river_tot, 3),
            ml = mean(lambda), 
            maxl = max(lambda), 
            minl = min(lambda)) |> 
   ungroup()
# Proportion of rivers with Endangered populations
fig_bar_42_prop <- dfplot |> 
ggplot(aes(x = flag_50_42y, y = rl_prop)) + 
  geom_col(aes(group = scen_est, fill = model_cat), position = "dodge") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", colour = "black") +
  scale_fill_manual(values = rep(myfillhex3, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(limits = c(0, NA), breaks = c(0, 0.5, 1), 
                     labels = c("", "0.5", "1.0")) + 
  labs(y = "river proportion", x = "Endangered (50% loss)") + 
  #coord_flip() + 
  facet_grid(BASIN_N + subbasn ~ model_namef) + 
  theme_bw() +
  theme(legend.position="none")
# Population growth
fig_bar_42_lambda <- dfplot |> 
ggplot(aes(x = flag_50_42y, y = ml)) + 
  geom_linerange(aes(group = interaction(scen_est, model_cat), 
                    ymin = minl, ymax = maxl), 
                position=position_dodge(.9)) +
  geom_point(aes(group = scen_est, colour = model_cat), 
                position=position_dodge(.9)) +
  geom_hline(yintercept = 1.0, linetype = "dashed", colour = "black") +
  scale_colour_manual(values = rep(myfillhex3, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(breaks = c(0.8, 0.9, 1)) + 
  labs(y = "population growth rate (lambda)", x = "Endangered (50% loss)") + 
  #coord_flip() + 
  facet_grid(BASIN_N + subbasn ~ model_namef) + 
  theme_bw() +
  theme(legend.position="none")

# save plot
# file name
ba <- paste(to_use[1, 'BASIN_N'], "_", to_use[1, 'SUBBASI'], sep = "")
dir_name <- "inst/other"
fig_name <- paste("fig_t42_", ba, ".png", sep = "")
fig_out <- paste(dir_name, fig_name, sep = "/")
# save
png(file = fig_out, bg = "transparent", 
    type = c("cairo"), 
    width = 9, height = 11, units = "in", res=600)
((fig_bar_42_prop + fig_bar_42_lambda) +
(patchwork::wrap_plots(fig_42_list, ncol = 1, nrow = nrow(to_use), 
                      widths = c(rep(1, nrow(to_use))), 
                      heights = c(rep(1, nrow(to_use))), 
                      guides = "collect"))) +
  plot_annotation("Population change 42 years (3 generations lower estimate)", 
                  tag_levels = list(c("A", "B", "C", "", "", "", ""))) + 
  plot_layout(widths = c(6, 6, 3)) 
invisible(dev.off())
```

#### Page 6

```{r make-groupsp6, echo=FALSE, warning=FALSE, message=FALSE}
# Apply same sequence to data and maps.
sid <- dfref |> 
  filter(BASIN_N == "Coastal North") |> pull(subbasn)
n_perpage <- 7
to_use <- dfref |> 
  filter(subbasn %in% sid[8:(n_perpage * 2)])
# Read into a list
fig_42_list <- lapply(to_use$apath, readRDS)
# Assign file names to list elements
names(fig_42_list) <- to_use$aname  
# values to plot. Check this as myabe summarise is not necessary.
dfplot <- sum_diff_current |> 
  filter(subbasn %in% to_use$subbasn) |>
  group_by(BASIN_N, subbasn, model_namef, scen_est, model_cat, flag_50_42y) |> 
  summarise(rl = sum(river_length), 
            rl_prop = round(sum(river_length) / river_tot, 3),
            ml = mean(lambda), 
            maxl = max(lambda), 
            minl = min(lambda)) |> 
   ungroup()
# Proportion of rivers with Endangered populations
fig_bar_42_prop <- dfplot |> 
ggplot(aes(x = flag_50_42y, y = rl_prop)) + 
  geom_col(aes(group = scen_est, fill = model_cat), position = "dodge") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", colour = "black") +
  scale_fill_manual(values = rep(myfillhex3, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(limits = c(0, NA), breaks = c(0, 0.5, 1), 
                     labels = c("", "0.5", "1.0")) + 
  labs(y = "river proportion", x = "Endangered (50% loss)") + 
  #coord_flip() + 
  facet_grid(BASIN_N + subbasn ~ model_namef) + 
  theme_bw() +
  theme(legend.position="none")
# Population growth
fig_bar_42_lambda <- dfplot |> 
ggplot(aes(x = flag_50_42y, y = ml)) + 
  geom_linerange(aes(group = interaction(scen_est, model_cat), 
                    ymin = minl, ymax = maxl), 
                position=position_dodge(.9)) +
  geom_point(aes(group = scen_est, colour = model_cat), 
                position=position_dodge(.9)) +
  geom_hline(yintercept = 1.0, linetype = "dashed", colour = "black") +
  scale_colour_manual(values = rep(myfillhex3, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(breaks = c(0.8, 0.9, 1)) + 
  labs(y = "population growth rate (lambda)", x = "Endangered (50% loss)") + 
  #coord_flip() + 
  facet_grid(BASIN_N + subbasn ~ model_namef) + 
  theme_bw() +
  theme(legend.position="none")

# save plot
# file name
ba <- paste(to_use[1, 'BASIN_N'], "_", to_use[1, 'SUBBASI'], sep = "")
dir_name <- "inst/other"
fig_name <- paste("fig_t42_", ba, ".png", sep = "")
fig_out <- paste(dir_name, fig_name, sep = "/")
# save
mynrow <- nrow(to_use)
# Need to check ggplot for these as sf complains about no x...?
png(file = fig_out, bg = "transparent", 
    type = c("cairo"), 
    width = 9, height = 11, units = "in", res=600)
((fig_bar_42_prop + fig_bar_42_lambda) +
(patchwork::wrap_plots(fig_42_list, ncol = 1, nrow = mynrow, 
                      widths = c(rep(1, mynrow)), 
                      heights = c(rep(1, mynrow)), 
                      guides = "collect"))) +
  plot_annotation("Population change 42 years (3 generations lower estimate)", 
                  tag_levels = list(c("A", "B", "C", "", "", "", ""))) + 
  plot_layout(widths = c(6, 6, 3)) 
invisible(dev.off())

# just use graphs for now....
png(file = fig_out, bg = "transparent", 
    type = c("cairo"), 
    width = 6, height = 11, units = "in", res=600)
(fig_bar_42_prop + fig_bar_42_lambda) +
  plot_annotation("Population change 42 years (3 generations lower estimate)", 
                  tag_levels = list(c("A", "B"))) + 
  plot_layout(widths = c(6, 6)) 
invisible(dev.off())

```

#### Page 7
```{r make-groupsp7, echo=FALSE, warning=FALSE, message=FALSE}
# Apply same sequence to data and maps.
sid <- dfref |> 
  filter(BASIN_N == "Coastal North") |> pull(subbasn)
n_perpage <- 7
to_use <- dfref |> 
  filter(subbasn %in% sid[15:(n_perpage * 3)])
# Read into a list
fig_42_list <- lapply(to_use$apath, readRDS)
# Assign file names to list elements
names(fig_42_list) <- to_use$aname  
# values to plot. Check this as myabe summarise is not necessary.
dfplot <- sum_diff_current |> 
  filter(subbasn %in% to_use$subbasn) |>
  group_by(BASIN_N, subbasn, model_namef, scen_est, model_cat, flag_50_42y) |> 
  summarise(rl = sum(river_length), 
            rl_prop = round(sum(river_length) / river_tot, 3),
            ml = mean(lambda), 
            maxl = max(lambda), 
            minl = min(lambda)) |> 
   ungroup()
# Proportion of rivers with Endangered populations
fig_bar_42_prop <- dfplot |> 
ggplot(aes(x = flag_50_42y, y = rl_prop)) + 
  geom_col(aes(group = scen_est, fill = model_cat), position = "dodge") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", colour = "black") +
  scale_fill_manual(values = rep(myfillhex3, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(limits = c(0, NA), breaks = c(0, 0.5, 1), 
                     labels = c("", "0.5", "1.0")) + 
  labs(y = "river proportion", x = "Endangered (50% loss)") + 
  #coord_flip() + 
  facet_grid(BASIN_N + subbasn ~ model_namef) + 
  theme_bw() +
  theme(legend.position="none")
# Population growth
fig_bar_42_lambda <- dfplot |> 
ggplot(aes(x = flag_50_42y, y = ml)) + 
  geom_linerange(aes(group = interaction(scen_est, model_cat), 
                    ymin = minl, ymax = maxl), 
                position=position_dodge(.9)) +
  geom_point(aes(group = scen_est, colour = model_cat), 
                position=position_dodge(.9)) +
  geom_hline(yintercept = 1.0, linetype = "dashed", colour = "black") +
  scale_colour_manual(values = rep(myfillhex3, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(breaks = c(0.8, 0.9, 1)) + 
  labs(y = "population growth rate (lambda)", x = "Endangered (50% loss)") + 
  #coord_flip() + 
  facet_grid(BASIN_N + subbasn ~ model_namef) + 
  theme_bw() +
  theme(legend.position="none")

# save plot
# file name
ba <- paste(to_use[1, 'BASIN_N'], "_", to_use[1, 'SUBBASI'], sep = "")
dir_name <- "inst/other"
fig_name <- paste("fig_t42_", ba, ".png", sep = "")
fig_out <- paste(dir_name, fig_name, sep = "/")
# same problem sf cant find x_start - need to correct breaks for super small regions.
# save
png(file = fig_out, bg = "transparent", 
    type = c("cairo"), 
    width = 9, height = 11, units = "in", res=600)
((fig_bar_42_prop + fig_bar_42_lambda) +
(patchwork::wrap_plots(fig_42_list, ncol = 1, nrow = nrow(to_use), 
                      widths = c(rep(1, nrow(to_use))), 
                      heights = c(rep(1, nrow(to_use))), 
                      guides = "collect"))) +
  plot_annotation("Population change 42 years (3 generations lower estimate)", 
                  tag_levels = list(c("A", "B", "C", "", "", "", ""))) + 
  plot_layout(widths = c(6, 6, 3)) 
invisible(dev.off())

# just use graphs for now....
png(file = fig_out, bg = "transparent", 
    type = c("cairo"), 
    width = 6, height = 11, units = "in", res=600)
(fig_bar_42_prop + fig_bar_42_lambda) +
  plot_annotation("Population change 42 years (3 generations lower estimate)", 
                  tag_levels = list(c("A", "B"))) + 
  plot_layout(widths = c(6, 6)) 
invisible(dev.off())

```

### Orinoco
#### Page 8
```{r make-groupsp8, echo=FALSE, warning=FALSE, message=FALSE}
# Apply same sequence to data and maps. Orinoco maps wrong way around.
sid <- dfref |> 
  filter(BASIN_N == "Orinoco") |> 
  arrange(SUBBASI) |> pull(subbasn)
n_perpage <- 7
to_use <- dfref |> 
  filter(subbasn %in% sid[1:(n_perpage * 1)]) |> 
  arrange(SUBBASI)
# Read into a list
fig_42_list <- lapply(to_use$apath, readRDS)
# Assign file names to list elements
names(fig_42_list) <- rev(to_use$aname)  
# values to plot. Check this as myabe summarise is not necessary.
dfplot <- sum_diff_current |> 
  filter(subbasn %in% to_use$subbasn) |>
  group_by(BASIN_N, subbasn, model_namef, scen_est, model_cat, flag_50_42y) |> 
  summarise(rl = sum(river_length), 
            rl_prop = round(sum(river_length) / river_tot, 3),
            ml = mean(lambda), 
            maxl = max(lambda), 
            minl = min(lambda)) |> 
   ungroup()
# Proportion of rivers with Endangered populations
fig_bar_42_prop <- dfplot |> 
ggplot(aes(x = flag_50_42y, y = rl_prop)) + 
  geom_col(aes(group = scen_est, fill = model_cat), position = "dodge") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", colour = "black") +
  scale_fill_manual(values = rep(myfillhex3, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(limits = c(0, NA), breaks = c(0, 0.5, 1), 
                     labels = c("", "0.5", "1.0")) + 
  labs(y = "river proportion", x = "Endangered (50% loss)") + 
  #coord_flip() + 
  facet_grid(BASIN_N + subbasn ~ model_namef) + 
  theme_bw() +
  theme(legend.position="none")
# Population growth
fig_bar_42_lambda <- dfplot |> 
ggplot(aes(x = flag_50_42y, y = ml)) + 
  geom_linerange(aes(group = interaction(scen_est, model_cat), 
                    ymin = minl, ymax = maxl), 
                position=position_dodge(.9)) +
  geom_point(aes(group = scen_est, colour = model_cat), 
                position=position_dodge(.9)) +
  geom_hline(yintercept = 1.0, linetype = "dashed", colour = "black") +
  scale_colour_manual(values = rep(myfillhex3, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(breaks = c(0.8, 0.9, 1)) + 
  labs(y = "population growth rate (lambda)", x = "Endangered (50% loss)") + 
  #coord_flip() + 
  facet_grid(BASIN_N + subbasn ~ model_namef) + 
  theme_bw() +
  theme(legend.position="none")

# save plot
# file name
ba <- paste(to_use[1, 'BASIN_N'], "_", to_use[1, 'SUBBASI'], sep = "")
dir_name <- "inst/other"
fig_name <- paste("fig_t42_", ba, ".png", sep = "")
fig_out <- paste(dir_name, fig_name, sep = "/")
# save
png(file = fig_out, bg = "transparent", 
    type = c("cairo"), 
    width = 9, height = 6, units = "in", res=600)
((fig_bar_42_prop + fig_bar_42_lambda) +
(patchwork::wrap_plots(fig_42_list, ncol = 1, nrow = nrow(to_use), 
                      widths = c(rep(1, nrow(to_use))), 
                      heights = c(rep(1, nrow(to_use))), 
                      guides = "collect"))) +
  plot_annotation("Population change 42 years (3 generations lower estimate)", 
                  tag_levels = list(c("A", "B", "C", "", "", "", ""))) + 
  plot_layout(widths = c(6, 6, 3)) 
invisible(dev.off())
```

### Coastal South
#### Page 9

```{r make-groupsp9, echo=FALSE, warning=FALSE, message=FALSE}
# Apply same sequence to data and maps.
sid <- dfref |> 
  filter(BASIN_N == "Coastal South") |> pull(subbasn)
n_perpage <- 7
to_use <- dfref |> 
  filter(subbasn %in% sid[1:(n_perpage * 1)])
# Read into a list
fig_42_list <- lapply(to_use$apath, readRDS)
# Assign file names to list elements
names(fig_42_list) <- to_use$aname  
# values to plot. Check this as myabe summarise is not necessary.
dfplot <- sum_diff_current |> 
  filter(subbasn %in% to_use$subbasn) |>
  group_by(BASIN_N, subbasn, model_namef, scen_est, model_cat, flag_50_42y) |> 
  summarise(rl = sum(river_length), 
            rl_prop = round(sum(river_length) / river_tot, 3),
            ml = mean(lambda), 
            maxl = max(lambda), 
            minl = min(lambda)) |> 
   ungroup()
# Proportion of rivers with Endangered populations
fig_bar_42_prop <- dfplot |> 
ggplot(aes(x = flag_50_42y, y = rl_prop)) + 
  geom_col(aes(group = scen_est, fill = model_cat), position = "dodge") + 
  geom_hline(yintercept = 0.5, linetype = "dashed", colour = "black") +
  scale_fill_manual(values = rep(myfillhex3, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(limits = c(0, NA), breaks = c(0, 0.5, 1), 
                     labels = c("", "0.5", "1.0")) + 
  labs(y = "river proportion", x = "Endangered (50% loss)") + 
  #coord_flip() + 
  facet_grid(BASIN_N + subbasn ~ model_namef) + 
  theme_bw() +
  theme(legend.position="none")
# Population growth
fig_bar_42_lambda <- dfplot |> 
ggplot(aes(x = flag_50_42y, y = ml)) + 
  geom_linerange(aes(group = interaction(scen_est, model_cat), 
                    ymin = minl, ymax = maxl), 
                position=position_dodge(.9)) +
  geom_point(aes(group = scen_est, colour = model_cat), 
                position=position_dodge(.9)) +
  geom_hline(yintercept = 1.0, linetype = "dashed", colour = "black") +
  scale_colour_manual(values = rep(myfillhex3, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(breaks = c(0.8, 0.9, 1)) + 
  labs(y = "population growth rate (lambda)", x = "Endangered (50% loss)") + 
  #coord_flip() + 
  facet_grid(BASIN_N + subbasn ~ model_namef) + 
  theme_bw() +
  theme(legend.position="none")

# save plot
# file name
ba <- paste(to_use[1, 'BASIN_N'], "_", to_use[1, 'SUBBASI'], sep = "")
dir_name <- "inst/other"
fig_name <- paste("fig_t42_", ba, ".png", sep = "")
fig_out <- paste(dir_name, fig_name, sep = "/")
# save
png(file = fig_out, bg = "transparent", 
    type = c("cairo"), 
    width = 9, height = 3, units = "in", res=600)
((fig_bar_42_prop + fig_bar_42_lambda) +
(patchwork::wrap_plots(fig_42_list, ncol = 1, nrow = nrow(to_use), 
                      widths = c(rep(1, nrow(to_use))), 
                      heights = c(rep(1, nrow(to_use))), 
                      guides = "collect"))) +
  plot_annotation("Population change 42 years (3 generations lower estimate)", 
                  tag_levels = list(c("A", "B", "C", "", "", "", ""))) + 
  plot_layout(widths = c(6, 6, 3)) 
invisible(dev.off())
```


## Other stuff
Join back with basins.
```{r join-basins, eval = FALSE}
# level 12 should have code to join with Free Flowing Rivers
fhybas_l12 <- "C:\\Users\\user\\Documents\\Articles\\gis_layers\\hydro_data\\hybas_sa_lev01-12_v1c\\hybas_sa_lev12_v1c.shp"
hybas_l12_3395 <- st_read(fhybas_l12) |> st_transform(3395)
hybas_l12_3395_crop <- st_crop(hybas_l12_3395, st_bbox(r_01_3395))
hybas_l12_3395_crop |> st_drop_geometry() |> pull(HYBAS_ID) |> table()
hybas_l12_3395_crop |> st_drop_geometry() |> pull(MAIN_BAS) |> table()
```

