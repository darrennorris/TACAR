---
title: "River sections"
author: "Darren Norris"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages
```{r load-packages, warning=FALSE, message=FALSE}
library(plyr)
library(tidyverse)
library(readxl)
library(sf)
library(patchwork)

```

Check what attributes were in cmartr version made using "Old_RiverlengthSummary.R".
Missing country and other basin details.
```{r load-river}
rpin <- "C:\\Users\\user\\Documents\\Articles\\2024_Norris_Greenstatus\\TACAR\\inst\\vector\\shapes_rivers3395\\riversec3395_1_2018021339.shp"
r_01_3395 <- read_sf(rpin) |> st_transform(3395)

pounf <- "C:\\Users\\user\\Documents\\IUCN_redgreen\\IUCN_greenstatus\\analysis\\vector\\poun_presence.gpkg"
basins_ffr_3395 <- read_sf(pounf, layer = "basins_ffr") |> st_transform(3395)

# crop to speed up processing.
basins_ffr_crop <- st_crop(basins_ffr_3395, st_bbox(r_01_3395))

```

See if intersection works with Free Flowing Rivers.
```{r spatial-check, warning=FALSE, message=FALSE}
# no where close to be spatially consistent.
mapview::mapview(basins_ffr_crop) + 
  mapview::mapview(r_01_3395)
```

Add free flowiong river data to points.
Spatial join. Get country, CSI_FF.
 
REACH_ID Reach Identifier. The reach identifier can be used to link 
this dataset to the HydroATLAS database.
COUNTRY
BAS_ID Basin Identifier. Identifies the hydrological river basin 
according to the HydroSHEDS framework.
BAS_NAME  Basin Name (if available).
RIV_ORD River order. River order is here defined and calculated based 
on the long-term average discharge (DIS_AV_CMS) using logarithmic progression:
1 = > 100000
2 = 10000 – 100000
3 = 1000 – 10000
4 = 100 – 1000
5 = 10 – 100
CSI above or below free-flowing threshold.
Indicates if the CSI value of a river reach is below (value = 0) or 
above (value = 1) the threshold of 95%.
BasinATLAS, RiverATLAS, and LakeATLAS are related through the 
level 12 HydroBASIN ID codes found in the attribute tables of each dataset. 
Every river reach in RiverATLAS and every lake in LakeATLAS shows 
the HydroBASINS ID (“HYBAS_ID”) of its corresponding level 12 HydroBASIN 
in which the reach or lake’s pour point is located.
https://hydrosheds.freeflarum.com/
```{r spatial-join}
# intersect. no data sources are not consistent reprsentation of rivers
# 111 obs
# ls_samp_sf <- st_intersection(st_buffer(basins_ffr_crop, 100), r_01_3395)
# 3030
ls_samp_sf <- st_join(r_01_3395, basins_ffr_crop, join = st_nearest_feature)
ls_samp_sf |> st_drop_geometry() |>
pull(BAS_ID) |> table() # 3418183
ls_samp_sf |> st_drop_geometry() |>
pull(BAS_NAME) |> table() # Amazon basin
ls_samp_sf |> st_drop_geometry() |>
pull(BB_NAME) |> table() # 7 backbone rivers
# Free-flowing status (three categories).
ls_samp_sf |> st_drop_geometry() |> 
  group_by(CSI_FF2) |> 
  summarise(CSI_mean = mean(CSI))
# Indicates if the CSI value of a river reach is below (value = 0) or 
# above (value = 1) the threshold of 95%.
ls_samp_sf |> st_drop_geometry() |> 
  group_by(CSI_FF) |> 
  summarise(CSI_mean = mean(CSI))

```

## Join with scenarios

Load lookup table.
```{r load-lookup}
# model_lookup has population projections created in "test_projections.Rmd".
model_lookup <- readRDS('inst/other/model_lookup.rds')
# actions has models associted with different scenarios
actions <- read_excel("inst/other/Podocnemis conservation actions.xlsx", 
                      sheet = "scenario_parameters", .name_repair = "universal")
```


```{r join-scenarios}
# Join model results to scenarios
scenario_res <- ls_samp_sf |> data.frame() |> 
  mutate(Protected = if_else(All == 1, "yes", "no"), 
         Accessible = if_else(accessible == "No", "no", "yes"), 
         Free.flowing = if_else(CSI_FF == 1, "yes", "no")
         ) |> left_join( 
           actions |> 
  filter(Podocnemis.modelling.scenario == "Protection") |> 
  pivot_longer(cols = starts_with("modelkey"), names_to = "model_name", 
               values_to = "modelkey") |> 
  left_join(model_lookup, by = join_by(modelkey == modelkey) 
            ), 
  by = c("Protected" = "Protected", "Accessible" = "Accessible", 
         "Free.flowing" = "Free.flowing"), 
  relationship = "many-to-many"
           )
# should be zero rows if join worked
test_join <- scenario_res |> 
  filter(is.na(lambda_mean)) |> nrow()

# summary
sum_diff_mean <- scenario_res |> 
  mutate(flag_50_42y = factor(if_else(fem_diff_t42 <= -0.5, 1, 0))) |>
  group_by(BASIN_N, subbasn, Protected, Accessible, Free.flowing, 
           model_name, flag_50_42y) |> 
  summarise(river_length = n(), 
            lambda = mean(lambda_mean), 
            diff_42y = mean(fem_diff_t42)) |> 
  ungroup() 
sum_diff_q25 <- scenario_res |> 
  mutate(flag_50_42y = factor(if_else(fem_diff_q25_t42 <= -0.5, 1, 0))) |>
  group_by(BASIN_N, subbasn, Protected, Accessible, Free.flowing, 
           model_name, flag_50_42y) |> 
  summarise(river_length = n(), 
            lambda = mean(lambda_q25), 
            diff_42y = mean(fem_diff_q25_t42)) |> 
  ungroup() 
sum_diff_q75 <- scenario_res |> 
  mutate(flag_50_42y = factor(if_else(fem_diff_q75_t42 <= -0.5, 1, 0))) |>
  group_by(BASIN_N, subbasn, Protected, Accessible, Free.flowing, 
           model_name, flag_50_42y) |> 
  summarise(river_length = n(), 
            lambda = mean(lambda_q75), 
            diff_42y = mean(fem_diff_q75_t42)) |> 
  ungroup() 

sum_diff <- bind_rows(sum_diff_mean |> mutate(scen_est = "mean"), 
                      sum_diff_q25 |> mutate(scen_est = "lower"), 
                      sum_diff_q75 |> mutate(scen_est = "upper"))
sum_diff$model_namef <- factor(sum_diff$model_name)
sum_diff$model_namef <- relevel(sum_diff$model_namef, ref = "modelkey_pessimistic")
levels(sum_diff$model_namef) <- c("pessimistic", "BAU", "optimistic") 
sum_diff$model_cat <- factor(paste(sum_diff$flag_50_42y, sum_diff$scen_est, sep = ""))
```

## Sexy figures 
Expected change over 42 years.
```{r fig-change-42}
# changes over 3 generations. test with lowest estimate.
# Expect to see differences.....
#colour gradient to follow map colours - get mute palette?
# calculate as % of river lengths
# to do - check with 5 basins. then check scenario development - 
# ajust to obtain more variation within stochastic - more runs?
# more variation across pessimistic, BAU and optimistic?
myfill <- c("lightsteelblue" ,"mediumpurple1", "mediumpurple3",
              "indianred3", "firebrick", "lightpink4")
fig_bar_42 <- sum_diff |> 
  group_by(model_namef, scen_est, model_cat, flag_50_42y) |> 
  summarise(rl = sum(river_length), 
            ml = mean(lambda)) |> 
  ungroup() |>
ggplot(aes(x = flag_50_42y, y = rl)) + 
  # geom_col(fill = rep(c("mediumpurple1", "firebrick"), 3)) +
  geom_col(aes(group = scen_est, fill = model_cat), position = "dodge") + 
  scale_fill_manual(values = rep(myfill, 3)) +
  scale_x_discrete(labels = c("no", "yes")) + 
  scale_y_continuous(limits = c(0, NA)) + 
  labs(y = "river length (km)", x = "50% loss") + 
  coord_flip() + 
  facet_wrap(~ model_namef, ncol = 1) + 
  theme(legend.position="none")
fig_bar_42
# Try to use bbox for sensible breaks.
# All on western hemisphere so this works
mybbox <-  st_bbox(st_as_sf(scenario_res) |> st_transform(4326))
myxmin <- ceiling(mybbox["xmin"])
myxmax <- floor(mybbox["xmax"])
fig_map_42 <- scenario_res |> 
  filter(model_name == "modelkey_BAU") |> 
  st_as_sf() |>
  ggplot() +
  geom_sf(aes(colour = fem_diff_t42)) + 
  scale_x_continuous(breaks = c(seq(myxmin, myxmax, by = 2))) +
  scale_colour_gradient2("BAU %\nchange")

fig_map_42 + fig_bar_42 + 
  plot_annotation("Population change 42 years", tag_levels = 'A')

```

Visualize with mapview.
```{r fig-interactive, eval = FALSE}
diff_100y <- st_as_sf(scenario_res) |> 
                   select(fem_diff_t100)
mapview::mapview(diff_100y, zcol = "fem_diff_t100")
```


Join back with basins.
```{r join-basins}
# level 12 should have code to join with Free Flowing Rivers
fhybas_l12 <- "C:\\Users\\user\\Documents\\Articles\\gis_layers\\hydro_data\\hybas_sa_lev01-12_v1c\\hybas_sa_lev12_v1c.shp"
hybas_l12_3395 <- st_read(fhybas_l12) |> st_transform(3395)
hybas_l12_3395_crop <- st_crop(hybas_l12_3395, st_bbox(r_01_3395))
hybas_l12_3395_crop |> st_drop_geometry() |> pull(HYBAS_ID) |> table()
hybas_l12_3395_crop |> st_drop_geometry() |> pull(MAIN_BAS) |> table()
```

